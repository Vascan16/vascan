<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Malica Manager</title>
    
    <!-- PWA / Mobile Web App Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/706/706164.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          darkMode: 'class',
          theme: {
            extend: {
              colors: {
                slate: {
                  850: '#151e2e',
                  950: '#020617',
                }
              }
            }
          }
        }
    </script>
    
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Babel za prevajanje JSX v brskalniku -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- ES Module Shims -->
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.8.0/dist/es-module-shims.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "prop-types": "https://esm.sh/prop-types@15.8.1",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0?external=react",
            "recharts": "https://esm.sh/recharts@2.12.3?external=react,react-dom,prop-types",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>
    
    <style>
        /* Custom Styles that can't be handled by Tailwind purely */
        @media print {
            @page { margin: 1cm; size: A4; }
            html, body { width: 100%; height: auto; margin: 0 !important; padding: 0 !important; overflow: visible !important; background-color: white !important; }
            body > * { display: none !important; }
            body > #root { display: block !important; width: 100%; height: auto; overflow: visible; }
            #root > * { display: none !important; }
            #root > .app-container { display: block !important; width: 100%; height: auto; overflow: visible; position: static; }
            .app-container > * { display: none !important; }
            .app-container > .print-container { display: block !important; width: 100%; height: auto; }
            .print-container {
                font-family: sans-serif;
                font-size: 10px;
                color: black;
                background: white;
            }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #ddd; padding: 4px; }
            .page-break { page-break-before: always; }
            .avoid-break { page-break-inside: avoid; }
            ::-webkit-scrollbar { display: none; }
        }
        .print-container { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .report-table th, .report-table td { border: 1px solid #e2e8f0; padding: 4px 6px; }
        .report-table th { background-color: #f8fafc; font-weight: bold; text-transform: uppercase; font-size: 9px; }
        .code-block { font-family: 'Courier New', Courier, monospace; background-color: #f8fafc; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px; white-space: pre-wrap; font-size: 9px; color: #334155; }
        @keyframes scroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }
        .animate-scroll { display: flex; width: max-content; animation: scroll 30s linear infinite; }
        .ticker-mask { mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 select-none transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
           Users, History, PlusCircle, Trash2, TrendingDown,
           CreditCard, UserPlus, ArrowRightCircle, ArrowDownCircle, Calendar,
           Wallet, Calculator, CheckCircle2, Download,
           AlertTriangle, FileText, CheckSquare, Square, Lock, Info, Scale,
           ListOrdered, RefreshCcw, Save, Table, Grid, Printer, Bell, X,
           Crown, PiggyBank, Ghost, Medal, Dices, Eye, EyeOff, BarChart3, Pizza, Settings, Utensils, StickyNote, PenLine,
           PieChart as IconPieChart, Activity, Database, ArrowRight, Play, Pause, RotateCcw, ChevronUp, ChevronDown, ChevronLeft, ChevronRight, Gamepad2, Moon, Sun,
           Sigma, BookOpen, Terminal, ShieldAlert
        } from 'lucide-react';
        
        // --- RECHARTS IMPORTS ---
        import {
             PieChart, Pie, Cell, ResponsiveContainer, Tooltip as RechartsTooltip,
             Legend, LineChart, Line, XAxis, YAxis, CartesianGrid, ReferenceLine
        } from 'recharts';

        import { initializeApp } from 'firebase/app';
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
          } from 'firebase/auth';
        import {
            getFirestore,
            collection,
            doc,
            setDoc,
            addDoc,
            deleteDoc,
            onSnapshot,
            query,
            writeBatch,
            getDocs,
            serverTimestamp
          } from 'firebase/firestore';

        // Error Boundary
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Critical App Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-sans">
                            <div className="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border-2 border-rose-100 dark:border-rose-900/30 max-w-sm">
                                <div className="bg-rose-100 dark:bg-rose-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500">
                                    <AlertTriangle size={32} />
                                </div>
                                <h1 className="text-xl font-black mb-2 text-slate-900 dark:text-white">Ups, nekaj se je zalomilo!</h1>
                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-6 font-mono bg-slate-100 dark:bg-slate-900 p-2 rounded">
                                    {this.state.error?.message || "Neznana napaka"}
                                </p>
                                <button onClick={() => window.location.reload()} className="w-full bg-[#002f55] dark:bg-[#e4b00f] text-white dark:text-[#002f55] py-3 rounded-xl font-bold shadow-lg">
                                    Osve≈æi Aplikacijo
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const MOJ_FIREBASE_CONFIG = {
          apiKey: "AIzaSyBjoIbXZEELew5F1zVnYzUbStp0IfVAwgg",
          authDomain: "malicamanagerpro.firebaseapp.com",
          projectId: "malicamanagerpro",
          storageBucket: "malicamanagerpro.firebasestorage.app",
          messagingSenderId: "902764840464",
          appId: "1:902764840464:web:7ad08867d6c6593efd2c95",
          measurementId: "G-WDP7KK30QQ"
        };

        let firebaseConfig;
        let appId;

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            } else {
                firebaseConfig = MOJ_FIREBASE_CONFIG;
                appId = 'malica-manager-v1';
             }
        } catch (e) {
            console.warn("Preklop na roƒçno konfiguracijo.");
            firebaseConfig = MOJ_FIREBASE_CONFIG;
            appId = 'malica-manager-v1';
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const _appVitals = {
          a_key: atob("MTI0Mw=="),
           e_key: atob("MTI0Mw=="),
           s_key: atob("MDAwMA==")
         };

        const ACCESS_CODE = _appVitals.a_key;
        const EDIT_CODE = _appVitals.e_key;
        const ADMIN_PIN = _appVitals.s_key;

        const CHART_COLORS = ['#002f55', '#e4b00f', '#10b981', '#f43f5e', '#8b5cf6', '#0ea5e9', '#f97316', '#64748b'];

        // ==========================================
        // 2. POMO≈ΩNE FUNKCIJE
        // ==========================================

        const money = (val) => Math.round((val + Number.EPSILON) * 100) / 100;

        const triggerFireworks = () => {
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 100 };
            const randomInRange = (min, max) => Math.random() * (max - min) + min;
            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = 50 * (timeLeft / duration);
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
            }, 250);
        };

        const triggerGoldBurst = () => {
              confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.7 },
                colors: ['#e4b00f', '#ffd700', '#fceeb5'],
                disableForReducedMotion: true
            });
        };

        const getMatrixValue = (entry, member, type) => {
          if (type === 'Z') {
            return entry.type === 'adjustment' && entry.user === member ? (parseFloat(entry.amount) || 0) : 0;
          }
          if (type === 'P') return entry.payer === member ? (parseFloat(entry.amount) || 0) : 0;
          else {
            if (entry.splitType === 'manual' && entry.manualAmounts) return parseFloat(entry.manualAmounts[member]) || 0;
            if (entry.participants && entry.participants.includes(member)) return (parseFloat(entry.amount) || 0) / entry.participants.length;
            return 0;
          }
        };

        const calculateTitles = (members, balances, history) => {
          const titles = {};
           const addTitle = (member, titleObj) => {
            if (!titles[member]) titles[member] = [];
            titles[member].push(titleObj);
          };

          if (members.length < 2 || history.length === 0) return titles;

          const maxBal = Math.max(...Object.values(balances));
          if (maxBal > 0) {
            const mecen = members.find(m => balances[m] === maxBal);
            if (mecen) addTitle(mecen, { icon: Crown, label: 'Mecen', color: 'text-yellow-600', bg: 'bg-yellow-100 border-yellow-200' });
          }

          const minBal = Math.min(...Object.values(balances));
          if (minBal < 0) {
            const gorenjec = members.find(m => balances[m] === minBal);
            if (gorenjec) addTitle(gorenjec, { icon: PiggyBank, label: 'Gorenjec', color: 'text-rose-600', bg: 'bg-rose-100 border-rose-200' });
          }

          const paymentCounts = {};
          members.forEach(m => paymentCounts[m] = 0);
          history.forEach(e => { if (e.type !== 'adjustment' && e.payer) paymentCounts[e.payer] = (paymentCounts[e.payer] || 0) + 1; });
          const maxPayments = Math.max(...Object.values(paymentCounts));
          if (maxPayments > 0) {
            const bankomat = members.find(m => paymentCounts[m] === maxPayments);
            if (bankomat) addTitle(bankomat, { icon: CreditCard, label: 'Bankomat', color: 'text-blue-600', bg: 'bg-blue-100 border-blue-200' });
          }

          const participationCounts = {};
          members.forEach(m => participationCounts[m] = 0);
          history.forEach(e => {
              if (e.type !== 'adjustment' && e.participants) {
              e.participants.forEach(p => participationCounts[p] = (participationCounts[p] || 0) + 1);
            }
          });
          const minPart = Math.min(...Object.values(participationCounts));
          if (history.length > 2) {
              const duh = members.find(m => participationCounts[m] === minPart);
              if (duh) addTitle(duh, { icon: Ghost, label: 'Duh', color: 'text-slate-500', bg: 'bg-slate-200 border-slate-300' });
          }

          const absBalances = members.map(m => Math.abs(balances[m] || 0));
          const minAbs = Math.min(...absBalances);
          const zenMasters = members.filter(m => Math.abs(balances[m] || 0) === minAbs);
          zenMasters.forEach(m => {
            addTitle(m, { icon: Scale, label: 'Zen', color: 'text-emerald-600', bg: 'bg-emerald-100 border-emerald-200' });
          });

          return titles;
        };

        const getMatlabCode = (history, members) => {
          const adjustments = history.filter(e => e.type === 'adjustment');
          const transactions = history.filter(e => e.type !== 'adjustment').reverse();
          const headerStr = `clc;\nclear all;\n`;
          const membersStr = `clani = {${members.map(m => `'${m}'`).join(', ')}};`;
          const zVector = members.map(m => adjustments.reduce((s, e) => s + (e.user === m ? e.amount : 0), 0).toFixed(2)).join(', ');
          const zStr = `Z = [${zVector}]; % Zaƒçetna stanja`;
          
          const pRows = transactions.length > 0 ? transactions.map(t => members.map(m => getMatrixValue(t, m, 'P').toFixed(2)).join(', ')) : [members.map(() => '0.00').join(', ')];
          const pStr = `P = [\n  ${pRows.join(';\n   ')}\n]; % Matrika Plaƒçil (P)`;
          
          const sRows = transactions.length > 0 ? transactions.map(t => members.map(m => getMatrixValue(t, m, 'S').toFixed(2)).join(', ')) : [members.map(() => '0.00').join(', ')];
          const sStr = `S = [\n  ${sRows.join(';\n   ')}\n]; % Matrika Porabe (S)`;

          const footerStr = `        % IZRAƒåUN KONƒåNIH BILANC\n        B = Z + sum(P, 1) - sum(S, 1);\n\n        fprintf('\\n--- KONƒåNA STANJA (Obraƒçun) ---\\n');\n        for i = 1:length(clani)\n            fprintf('%s: %.2f ‚Ç¨\\n', clani{i}, B(i));\n        end\n\n        fprintf('\\n--- PREDLAGAN PORAƒåUN (Navodila za poravnavo) ---\\n');\n        st_clanov = length(clani);\n        [stanja, idx] = sort(B); % Od najveƒçjega dolga do najveƒçjega upnika\n        upnik_kazalec = st_clanov;\n        dolznik_kazalec = 1;\n\n        while dolznik_kazalec < upnik_kazalec\n            if abs(stanja(dolznik_kazalec)) < 0.01\n                dolznik_kazalec = dolznik_kazalec + 1;\n                continue;\n            end\n            if abs(stanja(upnik_kazalec)) < 0.01\n                upnik_kazalec = upnik_kazalec - 1;\n                continue;\n            end\n            \n            znesek = min(abs(stanja(dolznik_kazalec)), stanja(upnik_kazalec));\n            if znesek > 0\n                fprintf('%s -> %s: %.2f ‚Ç¨\\n', clani{idx(dolznik_kazalec)}, clani{idx(upnik_kazalec)}, znesek);\n                stanja(dolznik_kazalec) = stanja(dolznik_kazalec) + znesek;\n                stanja(upnik_kazalec) = stanja(upnik_kazalec) - znesek;\n            end\n            \n            if abs(stanja(dolznik_kazalec)) < 0.01, dolznik_kazalec = dolznik_kazalec + 1; end\n            if abs(stanja(upnik_kazalec)) < 0.01, upnik_kazalec = upnik_kazalec - 1; end\n        end\n        `;

          return `${headerStr}\n${membersStr}\n\n${zStr}\n\n${pStr}\n\n${sStr}\n${footerStr}`;
         };

        // ==========================================
        // 3. UI KOMPONENTE
        // ==========================================

        const StatisticsModal = ({ show, onClose, onOpenGame, history }) => {
          const stats = useMemo(() => {
            const transactions = history.filter(e => e.type !== 'adjustment');
            if (transactions.length === 0) return null;

            const totalSpend = transactions.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            const totalParticipations = transactions.reduce((sum, e) => sum + (e.participants?.length || 0), 0);
            const avgLunch = totalParticipations > 0 ? totalSpend / totalParticipations : 0;
            
            const maxReceipt = Math.max(...transactions.map(e => parseFloat(e.amount) || 0));
            const bigSpender = transactions.find(e => parseFloat(e.amount) === maxReceipt)?.payer;

            const dayNames = ["Nedelja", "Ponedeljek", "Torek", "Sreda", "ƒåetrtek", "Petek", "Sobota"];
            const daySums = [0, 0, 0, 0, 0, 0, 0];
            transactions.forEach(e => {
              const day = new Date(e.date).getDay();
              daySums[day] += (parseFloat(e.amount) || 0);
            });
            const maxDayIdx = daySums.indexOf(Math.max(...daySums));

            const milestones = [
              { val: 20, label: "Zaboj kave", icon: "‚òï" },
              { val: 50, label: "Nekaj pic za ekipo", icon: "üçï" },
              { val: 100, label: "Poln tank goriva", icon: "‚õΩ" },
              { val: 250, label: "Po≈°teno veƒçerjo s steak-i", icon: "ü•©" },
              { val: 450, label: "Povratni let v New York", icon: "‚úàÔ∏è" },
              { val: 650, label: "Najnovej≈°i pametni telefon", icon: "üì±" },
              { val: 850, label: "Gaming konzolo", icon: "üéÆ" },
              { val: 1050, label: "Vrhunsko gorsko kolo", icon: "üö≤" },
              { val: 1300, label: "Elektriƒçni skiro", icon: "üõ¥" },
              { val: 1500, label: "Rabljen avto (Golf 2 style)", icon: "üöó" }
            ];

            const currentMilestoneIdx = milestones.findIndex(m => totalSpend < m.val);
            const progressMilestone = currentMilestoneIdx === -1 ? milestones[milestones.length-1] : milestones[currentMilestoneIdx];
            const progressPercent = Math.min((totalSpend / 1500) * 100, 100);

            return { totalSpend, avgLunch, maxReceipt, bigSpender, bestDay: dayNames[maxDayIdx], bestDayVal: daySums[maxDayIdx], milestones, progressPercent, progressMilestone, mealCount: transactions.length };
          }, [history]);

          if (!show) return null;

          return (
            <div className="fixed inset-0 bg-slate-900/90 z-[80] flex items-center justify-center p-4 backdrop-blur-md animate-fade-in no-print">
              <div className="bg-white dark:bg-slate-800 w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
                <div className="p-6 bg-[#002f55] dark:bg-slate-950 text-white flex justify-between items-center shrink-0">
                  <h2 className="text-xl font-black flex items-center gap-2"><BarChart3 /> Statistika</h2>
                  <div className="flex items-center gap-1">
                      {/* STEALTH GAME ICON */}
                      <button onClick={() => { onClose(); onOpenGame(); }} className="p-2 text-white/10 hover:text-white transition-colors duration-500 rounded-full">
                          <Sigma size={24} />
                      </button>
                      <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-colors"><X /></button>
                  </div>
                </div>
                                <div className="p-6 overflow-y-auto custom-scrollbar space-y-6">
                  {!stats ? (
                    <div className="text-center py-10 text-slate-400 italic">Ni dovolj podatkov za analizo.</div>
                  ) : (
                    <>
                      <div className="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-3xl border border-slate-100 dark:border-slate-700 text-center">
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Skupna poraba ekipe</p>
                        <h3 className="text-3xl font-black text-[#002f55] dark:text-[#e4b00f]">{stats.totalSpend.toFixed(2)} ‚Ç¨</h3>
                      </div>

                      <div className="space-y-3">
                        <div className="flex justify-between items-end">
                          <span className="text-xs font-bold text-slate-700 dark:text-slate-300">Skupaj smo pojedli za...</span>
                          <span className="text-[10px] font-black text-[#002f55] bg-[#e4b00f] px-2 py-0.5 rounded uppercase">{stats.progressMilestone.label}</span>
                        </div>
                        <div className="h-4 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden border border-slate-200 dark:border-slate-600">
                          <div className="h-full bg-gradient-to-r from-[#002f55] to-[#e4b00f] transition-all duration-1000" style={{ width: `${stats.progressPercent}%` }}></div>
                        </div>
                        <div className="flex justify-between text-[8px] font-bold text-slate-400 uppercase">
                          <span>0 ‚Ç¨</span>
                          <span>750 ‚Ç¨</span>
                          <span>1500 ‚Ç¨</span>
                        </div>
                      </div>

                      <div className="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-3xl border border-emerald-100 dark:border-emerald-900/50">
                        <div className="flex items-center gap-3">
                          <div className="bg-emerald-500 text-white p-2 rounded-2xl"><Calendar size={20} /></div>
                          <div>
                            <h4 className="text-xs font-black text-emerald-900 dark:text-emerald-400 uppercase">Najdra≈æji dan</h4>
                            <p className="text-sm font-bold text-emerald-700 dark:text-emerald-500">{stats.bestDay} ({stats.bestDayVal.toFixed(0)} ‚Ç¨)</p>
                          </div>
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-3 text-center">
                        <div className="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-3xl border border-slate-100 dark:border-slate-700">
                          <p className="text-[9px] font-bold text-slate-400 uppercase mb-1">Povpreƒçna malica</p>
                          <p className="text-lg font-black text-[#002f55] dark:text-white">{stats.avgLunch.toFixed(2)} ‚Ç¨</p>
                        </div>
                        <div className="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-3xl border border-slate-100 dark:border-slate-700">
                          <p className="text-[9px] font-bold text-slate-400 uppercase mb-1">≈†tevilo obrokov</p>
                          <p className="text-lg font-black text-[#002f55] dark:text-white">{stats.mealCount}</p>
                        </div>
                      </div>

                      <div className="p-4 bg-rose-50 dark:bg-rose-900/20 rounded-3xl border border-rose-100 dark:border-rose-900/50 flex items-center gap-3">
                        <div className="bg-rose-500 text-white p-2 rounded-2xl"><TrendingDown size={20} /></div>
                        <div>
                          <h4 className="text-xs font-black text-rose-900 dark:text-rose-400 uppercase">Najveƒçji raƒçun</h4>
                          <p className="text-sm font-bold text-rose-700 dark:text-rose-500">{stats.maxReceipt.toFixed(2)} ‚Ç¨ ({stats.bigSpender})</p>
                        </div>
                      </div>
                    </>
                  )}
                </div>
                <div className="p-6 bg-slate-50 dark:bg-slate-900 shrink-0">
                  <button onClick={onClose} className="w-full py-4 bg-[#002f55] dark:bg-[#e4b00f] text-white dark:text-[#002f55] rounded-2xl font-black text-sm shadow-xl">ZAPRI PREGLED</button>
                </div>
              </div>
            </div>
          );
        };

        const MessageModal = ({ show, message, setMessage, onConfirm, onCancel }) => {
          if (!show) return null;
          return (
            <div className="fixed inset-0 bg-slate-900/80 z-[90] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in no-print">
              <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-xs shadow-2xl border-2 border-yellow-100 dark:border-yellow-600/30 text-center relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-2 bg-yellow-400"></div>
                                <div className="flex justify-center mb-4 mt-2">
                    <div className="bg-yellow-100 dark:bg-yellow-900/30 p-4 rounded-full text-yellow-600 dark:text-yellow-400 shadow-sm">
                        <StickyNote size={32} />
                    </div>
                </div>
                                <h3 className="text-xl font-black text-slate-800 dark:text-white mb-2">Sporoƒçilo dneva</h3>
                <p className="text-xs text-slate-400 mb-4">Sporoƒçilo bo vidno vsem, dokler se ne vnese nov raƒçun.</p>
                                <textarea
                      autoFocus
                      value={message}
                      onChange={e => setMessage(e.target.value)}
                      placeholder="Npr. Danes gremo na burgerje..."
                      className="w-full bg-yellow-50/50 dark:bg-slate-700 border-2 border-yellow-200 dark:border-yellow-600/30 rounded-xl py-3 px-4 text-center font-bold text-slate-700 dark:text-white outline-none focus:border-yellow-400 focus:bg-white dark:focus:bg-slate-600 transition-all min-h-[80px] resize-none mb-4 placeholder:text-slate-400"
                      onKeyDown={e => {
                          if(e.key === 'Enter' && !e.shiftKey) {
                              e.preventDefault();
                              onConfirm();
                          }
                      }}
                />
                                <div className="flex gap-2">
                    <button onClick={onCancel} className="flex-1 py-3 text-slate-400 font-bold bg-slate-50 dark:bg-slate-700 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors">Prekliƒçi</button>
                    <button onClick={onConfirm} className="flex-1 py-3 bg-yellow-400 text-yellow-900 font-bold rounded-xl shadow-lg hover:bg-yellow-500 transition-colors">Objavi</button>
                </div>
              </div>
            </div>
          );
        };
        
        // --- NEW COMPONENT: INSTRUCTIONS EDIT MODAL ---
        const InstructionsEditModal = ({ show, instructions, setInstructions, onConfirm, onCancel }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/80 z-[95] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in no-print">
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-md shadow-2xl border-2 border-slate-100 dark:border-slate-700 flex flex-col max-h-[85vh]">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="bg-slate-100 dark:bg-slate-700 p-3 rounded-full text-[#002f55] dark:text-[#e4b00f]">
                                <BookOpen size={24} />
                            </div>
                            <div>
                                <h3 className="text-xl font-black text-slate-800 dark:text-white">Uredi Navodila</h3>
                                <p className="text-xs text-slate-500 dark:text-slate-400">Vidno vsem uporabnikom v nastavitvah.</p>
                            </div>
                        </div>
                                                                <textarea
                                    autoFocus
                                    value={instructions}
                                    onChange={e => setInstructions(e.target.value)}
                                    placeholder="Vpi≈°i navodila, pravila igre, IBAN..."
                                    className="w-full flex-1 bg-slate-50 dark:bg-slate-900/50 border-2 border-slate-200 dark:border-slate-700 rounded-xl p-4 font-mono text-sm text-slate-700 dark:text-slate-300 outline-none focus:border-[#002f55] dark:focus:border-[#e4b00f] transition-all min-h-[200px] resize-none mb-4 custom-scrollbar"
                                />
                                                                <div className="flex gap-2 mt-auto">
                            <button onClick={onCancel} className="flex-1 py-3 text-slate-400 font-bold bg-slate-50 dark:bg-slate-700 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors">Prekliƒçi</button>
                            <button onClick={onConfirm} className="flex-1 py-3 bg-[#002f55] dark:bg-[#e4b00f] text-white dark:text-[#002f55] font-bold rounded-xl shadow-lg hover:opacity-90 transition-opacity">Shrani</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ inputCode, setInputCode, checkAccess, authError }) => (
          <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6 text-white font-sans">
            <div className="max-w-xs w-full text-center space-y-8 animate-fade-in">
              <div className="inline-flex p-4 bg-[#002f55] rounded-3xl shadow-2xl border-2 border-[#e4b00f]"><Lock size={48} className="text-white" /></div>
              <h1 className="text-3xl font-black">Malica Manager</h1>
              <div className="space-y-4">
                <input type="password" inputMode="numeric" value={inputCode} onChange={e => setInputCode(e.target.value)} onKeyDown={e => e.key === 'Enter' && checkAccess()} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="w-full bg-slate-800 border-2 border-slate-700 rounded-2xl py-4 text-center text-3xl font-bold tracking-[1em] outline-none focus:border-[#e4b00f] transition-all" autoFocus />
                {authError && <p className="text-rose-500 text-xs font-bold animate-bounce">Napaƒçna koda!</p>}
                <button onClick={checkAccess} className="w-full bg-[#002f55] hover:bg-[#001f3f] py-4 rounded-2xl font-black text-lg shadow-xl shadow-[#002f55]/20 text-[#e4b00f]">ODKLENI</button>
              </div>
            </div>
          </div>
        );

        const LoadingScreen = () => (
          <div className="min-h-screen bg-slate-50 dark:bg-slate-950 flex items-center justify-center font-sans text-slate-400">
            <div className="text-center">
              <RefreshCcw className="animate-spin mx-auto mb-2 text-[#002f55] dark:text-[#e4b00f]" />
              <p className="font-bold text-[#002f55] dark:text-[#e4b00f]">Nalaganje...</p>
            </div>
          </div>
        );

        const RouletteModal = ({ members, balances, show, onClose }) => {
          const [currentName, setCurrentName] = useState("Kdo bo?");
          const [isSpinning, setIsSpinning] = useState(false);
          const [winner, setWinner] = useState(null);

          useEffect(() => {
            if (show) {
              setWinner(null);
              setCurrentName("Pritisni START");
              setIsSpinning(false);
            }
          }, [show]);

          const selectWeightedWinner = () => {
            const maxBal = Math.max(...Object.values(balances));
            const weightedMembers = [];
            members.forEach(m => {
              const bal = balances[m] || 0;
              const weight = Math.floor((maxBal - bal) + 10);
               for(let i=0; i<weight; i++) weightedMembers.push(m);
            });
            if (weightedMembers.length === 0) return members[Math.floor(Math.random() * members.length)];
            return weightedMembers[Math.floor(Math.random() * weightedMembers.length)];
          };

          const startSpin = () => {
            if (isSpinning) return;
            setIsSpinning(true);
            setWinner(null);
            const finalWinner = selectWeightedWinner();
            let speed = 50;
            let counter = 0;
            const maxSteps = 40;
             const spinInterval = () => {
              const randomName = members[Math.floor(Math.random() * members.length)];
              setCurrentName(randomName);
              counter++;
              if (counter < maxSteps) {
                if (counter > maxSteps - 10) speed += 30;
                setTimeout(spinInterval, speed);
              } else {
                setCurrentName(finalWinner);
                setWinner(finalWinner);
                setIsSpinning(false);
                triggerFireworks();
               }
            };
            spinInterval();
          };

          if (!show) return null;

          return (
            <div className="fixed inset-0 bg-slate-900/90 z-[70] flex items-center justify-center p-6 backdrop-blur-md animate-fade-in no-print">
              <div className="w-full max-w-sm text-center relative">
                <button onClick={onClose} className="absolute -top-12 right-0 text-white/50 hover:text-white"><X size={32} /></button>
                <div className="mb-8">
                  <Dices size={64} className={`mx-auto text-[#e4b00f] ${isSpinning ? 'animate-bounce' : ''}`} />
                  <h2 className="text-2xl font-black text-white mt-4 uppercase tracking-widest">Kdo Plaƒça?</h2>
                  <p className="text-white/50 text-xs">Ute≈æen ≈æreb: Veƒçji dolg = Veƒçja smola</p>
                </div>
                <div className="bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-[0_0_50px_rgba(228,176,15,0.3)] border-4 border-[#e4b00f] relative overflow-hidden">
                  <div className="h-24 flex items-center justify-center overflow-hidden">
                      <div className={`text-4xl font-black text-[#002f55] dark:text-white transition-all ${winner ? 'scale-125' : ''}`}>
                        {currentName}
                      </div>
                  </div>
                  {winner && <div className="absolute inset-0 pointer-events-none flex items-center justify-center"><div className="w-full h-full bg-[#e4b00f]/10 animate-pulse"></div></div>}
                </div>
                {!isSpinning && !winner && <button onClick={startSpin} className="mt-8 w-full bg-[#e4b00f] text-[#002f55] py-4 rounded-2xl font-black text-xl shadow-xl hover:scale-105 transition-transform active:scale-95">ZAVRTI üé≤</button>}
                {winner && <div className="mt-8 space-y-3"><div className="text-white text-lg font-bold animate-bounce">üéä {winner} ƒçast√≠! üéä</div><button onClick={startSpin} className="w-full bg-[#002f55] dark:bg-white border-2 border-[#e4b00f] text-[#e4b00f] dark:text-[#002f55] py-3 rounded-xl font-bold">Ponovi vajo</button></div>}
              </div>
            </div>
          );
        };

        const SnakeGame = ({ onClose, instantToggleBlur, isBlurred }) => {
            const canvasRef = useRef(null);
            const [score, setScore] = useState(0);
            const [highScore, setHighScore] = useState(parseInt(localStorage.getItem('snake_highscore') || '0'));
            const [gameOver, setGameOver] = useState(false);
            const [isPaused, setIsPaused] = useState(false);
            
            // Refs za prepreƒçevanje stale closure v gameLoop
            const gameOverRef = useRef(false);
            const isPausedRef = useRef(false);
            
            // Game State Refs
            const snake = useRef([{x: 10, y: 10}]);
            const food = useRef({x: 15, y: 5, emoji: 'üçï'});
            const dir = useRef({x: 0, y: 0});
            const nextDir = useRef({x: 0, y: 0});
            const gameLoopRef = useRef(null);
            
            const GRID_COUNT = 20;
            const CELL_SIZE = 15; // Base size, scaled by canvas
            const FOODS = ['üçï', 'üçî', 'üçü', 'üåÆ', 'üç©', 'üçé', 'üçê', 'üçå'];

            const startGame = () => {
                snake.current = [{x: 10, y: 10}];
                dir.current = {x: 0, y: 0};
                nextDir.current = {x: 0, y: 0};
                setScore(0);
                
                setGameOver(false);
                gameOverRef.current = false;
                
                setIsPaused(false);
                isPausedRef.current = false;
                
                placeFood();
                if(gameLoopRef.current) clearInterval(gameLoopRef.current);
                gameLoopRef.current = setInterval(gameLoop, 200);
            };

            const placeFood = () => {
                let newFood;
                let isOnSnake = true;
                while(isOnSnake) {
                    newFood = {
                        x: Math.floor(Math.random() * GRID_COUNT),
                        y: Math.floor(Math.random() * GRID_COUNT),
                        emoji: FOODS[Math.floor(Math.random() * FOODS.length)]
                    };
                    isOnSnake = snake.current.some(s => s.x === newFood.x && s.y === newFood.y);
                }
                food.current = newFood;
            };

            const gameLoop = () => {
                if(gameOverRef.current || isPausedRef.current) return;
                
                dir.current = nextDir.current;
                if(dir.current.x === 0 && dir.current.y === 0) return;

                const head = { ...snake.current[0] };
                head.x += dir.current.x;
                head.y += dir.current.y;

                // Collision with walls
                if(head.x < 0 || head.x >= GRID_COUNT || head.y < 0 || head.y >= GRID_COUNT) {
                    handleGameOver();
                    return;
                }

                // Collision with self
                if(snake.current.some(s => s.x === head.x && s.y === head.y)) {
                    handleGameOver();
                    return;
                }

                snake.current.unshift(head);

                // Eat food
                if(head.x === food.current.x && head.y === food.current.y) {
                    setScore(s => {
                        const newScore = s + 1;
                        if(newScore > highScore) {
                            setHighScore(newScore);
                            localStorage.setItem('snake_highscore', newScore);
                        }
                        return newScore;
                    });
                    confetti({
                        particleCount: 20,
                        spread: 50,
                        origin: { y: 0.8 },
                        colors: ['#e4b00f', '#10b981'],
                        startVelocity: 15,
                        disableForReducedMotion: true,
                        zIndex: 1000
                    });
                    placeFood();
                } else {
                    snake.current.pop();
                }
                draw();
            };

            const handleGameOver = () => {
                setGameOver(true);
                gameOverRef.current = true;
                clearInterval(gameLoopRef.current);
            };

            const draw = () => {
                const canvas = canvasRef.current;
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const cellSize = width / GRID_COUNT;

                // Clear
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, 0, width, width);

                // Grid (Optional - faint)
                ctx.strokeStyle = '#1e293b';
                ctx.lineWidth = 1;
                for(let i=0; i<=GRID_COUNT; i++) {
                    ctx.beginPath();
                    ctx.moveTo(i*cellSize, 0);
                    ctx.lineTo(i*cellSize, width);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(0, i*cellSize);
                    ctx.lineTo(width, i*cellSize);
                    ctx.stroke();
                }

                // Food
                ctx.font = `${cellSize - 2}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(food.current.emoji, food.current.x * cellSize + cellSize/2, food.current.y * cellSize + cellSize/2 + 2);

                // Snake
                snake.current.forEach((segment, i) => {
                    ctx.fillStyle = i === 0 ? '#e4b00f' : '#10b981';
                    ctx.beginPath();
                    ctx.roundRect(
                        segment.x * cellSize + 1,
                        segment.y * cellSize + 1,
                        cellSize - 2,
                        cellSize - 2,
                        4
                    );
                    ctx.fill();
                });
            };

            useEffect(() => {
                startGame();
                const handleKey = (e) => {
                    switch(e.key) {
                        case 'ArrowUp': if(dir.current.y !== 1) nextDir.current = {x: 0, y: -1}; break;
                        case 'ArrowDown': if(dir.current.y !== -1) nextDir.current = {x: 0, y: 1}; break;
                        case 'ArrowLeft': if(dir.current.x !== 1) nextDir.current = {x: -1, y: 0}; break;
                        case 'ArrowRight': if(dir.current.x !== -1) nextDir.current = {x: 1, y: 0}; break;
                    }
                };
                window.addEventListener('keydown', handleKey);
                return () => {
                    window.removeEventListener('keydown', handleKey);
                    clearInterval(gameLoopRef.current);
                };
            }, []);

            useEffect(() => {
                draw();
            }, [gameOver, score]); // Redraw on state change too

            const handleTouchControl = (d) => {
                switch(d) {
                    case 'UP': if(dir.current.y !== 1) nextDir.current = {x: 0, y: -1}; break;
                    case 'DOWN': if(dir.current.y !== -1) nextDir.current = {x: 0, y: 1}; break;
                    case 'LEFT': if(dir.current.x !== 1) nextDir.current = {x: -1, y: 0}; break;
                    case 'RIGHT': if(dir.current.x !== -1) nextDir.current = {x: 1, y: 0}; break;
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900/95 z-[100] flex flex-col items-center justify-center p-4 backdrop-blur-sm animate-fade-in touch-none select-none">
                                        {/* Instant Blur Button for Score >= 20 */}
                    {score >= 20 && (
                        <button
                            onClick={instantToggleBlur}
                            className="absolute bottom-6 left-6 z-[120] text-3xl opacity-50 hover:opacity-100 transition-opacity"
                            title="Razkrij/Skrij"
                        >
                            {isBlurred ? 'üôà' : 'üëÅÔ∏è'}
                        </button>
                    )}

                    <div className="w-full max-w-sm flex flex-col items-center">
                        <div className="flex justify-between w-full mb-4 text-white items-center">
                            <div className="flex flex-col">
                                <span className="text-[10px] text-slate-400 uppercase font-bold">Score</span>
                                <span className="text-2xl font-black font-mono text-[#e4b00f]">{score} ‚Ç¨</span>
                            </div>
                            <div className="flex flex-col text-right">
                                <span className="text-[10px] text-slate-400 uppercase font-bold">Best</span>
                                <span className="text-xl font-bold font-mono">{highScore} ‚Ç¨</span>
                            </div>
                            <button onClick={onClose} className="bg-slate-800 p-2 rounded-full text-white hover:bg-slate-700 ml-4"><X size={20}/></button>
                        </div>

                        <div className="relative border-4 border-slate-700 rounded-xl overflow-hidden shadow-2xl bg-[#0f172a]">
                            <canvas ref={canvasRef} width={300} height={300} className="block" />
                            
                            {gameOver && (
                                <div className="absolute inset-0 bg-black/60 flex flex-col items-center justify-center text-white">
                                    <h2 className="text-3xl font-black text-rose-500 mb-2">GAME OVER</h2>
                                    <p className="mb-4">Zaslu≈æek: {score} ‚Ç¨</p>
                                    <button onClick={startGame} className="bg-[#e4b00f] text-[#002f55] px-6 py-3 rounded-xl font-black flex items-center gap-2 hover:scale-105 transition-transform"><RotateCcw size={20} /> PONOVI</button>
                                </div>
                            )}
                            
                            {!gameOver && score === 0 && dir.current.x === 0 && dir.current.y === 0 && (
                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <p className="text-white/50 text-xs animate-pulse">Pritisni smer za start</p>
                                </div>
                            )}
                        </div>

                        {/* Mobile Controls */}
                        <div className="mt-8 grid grid-cols-3 gap-2 w-full max-w-[200px]">
                            <div></div>
                            <button className="bg-slate-800/80 p-4 rounded-xl text-white flex justify-center active:bg-[#e4b00f] active:text-[#002f55] transition-colors" onPointerDown={(e) => {e.preventDefault(); handleTouchControl('UP');}}><ChevronUp size={24} /></button>
                            <div></div>
                            <button className="bg-slate-800/80 p-4 rounded-xl text-white flex justify-center active:bg-[#e4b00f] active:text-[#002f55] transition-colors" onPointerDown={(e) => {e.preventDefault(); handleTouchControl('LEFT');}}><ChevronLeft size={24} /></button>
                            <button className="bg-slate-800/80 p-4 rounded-xl text-white flex justify-center active:bg-[#e4b00f] active:text-[#002f55] transition-colors" onPointerDown={(e) => {e.preventDefault(); handleTouchControl('DOWN');}}><ChevronDown size={24} /></button>
                            <button className="bg-slate-800/80 p-4 rounded-xl text-white flex justify-center active:bg-[#e4b00f] active:text-[#002f55] transition-colors" onPointerDown={(e) => {e.preventDefault(); handleTouchControl('RIGHT');}}><ChevronRight size={24} /></button>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminModal = ({ show, pin, setPin, error, pendingAction, onConfirm, onCancel }) => {
          if (!show) return null;
          const isEditingAction = pendingAction?.type === 'ADD' || pendingAction?.type === 'ADD_MEMBER';
          const isBlurToggle = pendingAction?.type === 'TOGGLE_BLUR';
          const isEditInstructions = pendingAction?.type === 'EDIT_INSTRUCTIONS';
          const isShowVisitLog = pendingAction?.type === 'SHOW_VISIT_LOG';
          
          return (
            <div className="fixed inset-0 bg-slate-900/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in no-print">
              <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-xs shadow-2xl border-2 border-slate-100 dark:border-slate-700 text-center">
                <div className="flex justify-center mb-4"><div className="bg-[#002f55]/10 dark:bg-slate-700 p-3 rounded-full text-[#002f55] dark:text-white"><Lock size={32} /></div></div>
                <h3 className="text-xl font-black text-slate-800 dark:text-white mb-2">Varnostna koda</h3>
                <p className="text-slate-500 dark:text-slate-400 text-xs mb-4">
                  {isShowVisitLog ? 'Za vpogled v dnevnik je potreben ADMIN PIN.' : (isBlurToggle || isEditInstructions ? 'Za to akcijo potrebuje≈° ADMIN PIN.' : (isEditingAction ? 'Za to akcijo je potrebna koda za urejanje.' : 'Za to akcijo je potreben administratorski PIN.'))}
                </p>
                <input type="password" inputMode="numeric" autoFocus value={pin} onChange={e => setPin(e.target.value)} onKeyDown={e => e.key === 'Enter' && onConfirm()} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="w-full bg-slate-100 dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-xl py-3 text-center text-2xl font-bold tracking-widest outline-none focus:border-[#e4b00f] dark:text-white mb-2" />
                {error && <p className="text-rose-500 text-xs font-bold mb-4 animate-bounce">Napaƒçna koda!</p>}
                <div className="flex gap-2 mt-4"><button onClick={onCancel} className="flex-1 py-3 text-slate-400 dark:text-slate-300 font-bold bg-slate-50 dark:bg-slate-700 rounded-xl">Prekliƒçi</button><button onClick={onConfirm} className="flex-1 py-3 bg-[#002f55] dark:bg-[#e4b00f] text-white dark:text-[#002f55] font-bold rounded-xl shadow-lg">Potrdi</button></div>
              </div>
            </div>
          );
        };

        const DeleteConfirmModal = ({ entry, onConfirm, onCancel }) => {
          if (!entry) return null;
          return (
            <div className="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in no-print">
              <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl border-2 border-slate-100 dark:border-slate-700">
                <div className="flex justify-center mb-4"><div className="bg-rose-100 dark:bg-rose-900/30 p-3 rounded-full text-rose-500"><Trash2 size={32} /></div></div>
                <h3 className="text-xl font-black text-center text-slate-800 dark:text-white mb-2">Izbri≈°em vnos?</h3>
                <p className="text-center text-slate-500 dark:text-slate-400 mb-6 text-sm">Tega dejanja ni mogoƒçe razveljaviti.</p>
                <div className="flex gap-3"><button onClick={onCancel} className="flex-1 py-3 font-bold text-slate-500 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-600">Prekliƒçi</button><button onClick={onConfirm} className="flex-1 py-3 font-bold text-white bg-rose-500 rounded-xl hover:bg-rose-600 shadow-lg shadow-rose-200">Izbri≈°i</button></div>
              </div>
            </div>
          );
        };

        const PrintReport = ({ history, members, balances, settlements }) => (
          <div className="print-container p-8">
            <div className="text-center border-b-2 border-slate-800 pb-4 mb-6">
              <h1 className="text-2xl font-black uppercase tracking-tight">Poroƒçilo Malica Manager</h1>
              <p className="text-xs text-slate-500">Ustvarjeno: {new Date().toLocaleString('sl-SI')}</p>
            </div>
            {history.some(e => e.type === 'adjustment') && (
              <div className="mb-6 avoid-break"><h3 className="font-bold text-sm mb-2 uppercase border-b border-slate-200">1. Zaƒçetna Stanja</h3><div className="grid grid-cols-4 gap-2">{history.filter(e => e.type === 'adjustment').map(e => (<div key={e.id} className="border p-2 text-xs flex justify-between rounded bg-slate-50"><span>{e.user}</span> <span className="font-bold">{e.amount.toFixed(2)} ‚Ç¨</span></div>))}</div></div>
            )}
            <div className="mb-6 avoid-break">
                <h3 className="font-bold text-sm mb-2 uppercase border-b border-slate-200">2. Povzetek Obdobja</h3>
                <table className="w-full text-xs report-table">
                    <thead>
                        <tr className="bg-slate-100">
                            <th>ƒålan</th>
                            <th className="text-right">Zaƒçetno</th>
                            <th className="text-right">Vplaƒçila (P)</th>
                            <th className="text-right">Poraba (S)</th>
                            <th className="text-right">Neto Stanje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {members.map(m => {
                            const zTot = history.reduce((sum, e) => sum + getMatrixValue(e, m, 'Z'), 0);
                            const pTot = history.reduce((sum, e) => { if (e.type === 'adjustment') return sum; return sum + (e.payer === m ? (parseFloat(e.amount) || 0) : 0) }, 0);
                             const sTot = history.reduce((sum, e) => { if (e.type === 'adjustment') return sum; return sum + getMatrixValue(e, m, 'S') }, 0);
                             const bal = balances[m] || 0;
                             return (
                                <tr key={m}>
                                    <td className="font-bold">{m}</td>
                                    <td className="text-right text-slate-500">{zTot.toFixed(2)} ‚Ç¨</td>
                                    <td className="text-right">{pTot.toFixed(2)} ‚Ç¨</td>
                                    <td className="text-right">{sTot.toFixed(2)} ‚Ç¨</td>
                                    <td className={`text-right font-bold ${bal >= 0 ? 'text-green-700' : 'text-red-700'}`}>{bal >= 0 ? '+' : ''}{bal.toFixed(2)} ‚Ç¨</td>
                                </tr>
                            )
                        })}
                    </tbody>
                </table>
            </div>
            <div className="mb-6 avoid-break"><h3 className="font-bold text-sm mb-2 uppercase border-b border-slate-200">3. Predlagan Poraƒçun</h3>{settlements.length > 0 ? (<div className="grid grid-cols-2 gap-4">{settlements.map((s, i) => (<div key={i} className="border p-2 text-xs flex justify-between items-center bg-slate-50 rounded"><span className="font-medium">{s.from} &rarr; {s.to}</span> <span className="font-black bg-slate-900 text-white px-2 py-0.5 rounded">{s.amount.toFixed(2)} ‚Ç¨</span></div>))}</div>) : <p className="italic text-slate-500 text-xs">Vse poravnano.</p>}</div>
            <div className="mb-6"><h3 className="font-bold text-sm mb-3 uppercase tracking-wider border-b pb-1">4. Transakcije</h3><table className="w-full text-[9px] report-table"><thead><tr className="bg-slate-100"><th className="w-16">Datum</th><th>Opis</th><th className="w-12 text-right">Znesek</th>{members.map(m => <th key={m} className="text-center w-6">{m.substring(0, 3)}</th>)}</tr></thead><tbody>{history.filter(e => e.type !== 'adjustment').map(e => (<tr key={e.id} className="avoid-break"><td>{new Date(e.date).toLocaleDateString('sl-SI')}</td><td className="truncate max-w-[100px]">{e.opis}</td><td className="text-right font-bold">{e.amount.toFixed(2)}</td>{members.map(m => {const p = getMatrixValue(e, m, 'P'); const s = getMatrixValue(e, m, 'S'); return (<td key={m} className="text-center">{p > 0 && <div className="text-emerald-600 font-bold">{Math.round(p)}</div>}{s > 0 && <div className="text-rose-400">-{Math.round(s)}</div>}</td>)})}</tr>))}</tbody></table></div>
            <div className="avoid-break page-break"><h3 className="font-bold text-sm mb-3 uppercase tracking-wider border-b pb-1">5. Matlab Izvoz</h3><p className="text-[9px] text-slate-500 mb-2">Kopirajte spodnjo kodo in jo prilepite neposredno v Matlab za nadaljnjo analizo.</p><div className="code-block">{getMatlabCode(history, members)}</div></div>
          </div>
        );

        const Navigation = ({ activeTab, setActiveTab, isBlurred }) => (
          <nav className="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 px-6 py-2 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.05)] print:hidden z-50 transition-colors">
            <div className="max-w-md mx-auto flex justify-between items-center">
              <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'dashboard' ? 'text-[#002f55] dark:text-white bg-slate-100 dark:bg-slate-800 scale-105' : 'text-slate-400'}`}><TrendingDown size={22} /><span className="text-[10px] mt-1 font-bold">Stanje</span></button>
                            <button onClick={() => setActiveTab('analytics')} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'analytics' ? 'text-[#002f55] dark:text-white bg-slate-100 dark:bg-slate-800 scale-105' : 'text-slate-400'}`}><Activity size={22} /><span className="text-[10px] mt-1 font-bold">Analitika</span></button>
                            <div className="relative -top-8"><button onClick={() => setActiveTab('add')} className={`w-16 h-16 rounded-full flex items-center justify-center shadow-2xl ${activeTab === 'add' ? 'bg-[#002f55] dark:bg-[#e4b00f] border-[#e4b00f] dark:border-[#002f55] text-[#e4b00f] dark:text-[#002f55]' : 'bg-[#002f55] dark:bg-[#002f55] border-white dark:border-slate-800 text-[#e4b00f]'} border-4 active:scale-90 transition-all`}><PlusCircle size={32} /></button></div>
                            <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'history' ? 'text-[#002f55] dark:text-white bg-slate-100 dark:bg-slate-800 scale-105' : 'text-slate-400'}`}><History size={22} /><span className="text-[10px] mt-1 font-bold">Zgodovina</span></button>
                            <button
                 onClick={() => !isBlurred && setActiveTab('settle')}
                 className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'settle' ? 'text-[#002f55] dark:text-white bg-slate-100 dark:bg-slate-800 scale-105' : 'text-slate-400'} ${isBlurred ? 'opacity-30 cursor-not-allowed' : ''}`}
                disabled={isBlurred}
              >
                <Calculator size={22} />
                <span className="text-[10px] mt-1 font-bold">Obraƒçun</span>
              </button>
            </div>
          </nav>
        );

        // ==========================================
        // 4. ZAVIHKI
        // ==========================================

        const TabAnalytics = ({ history, members, setActiveTab, isBlurred, darkMode }) => {
            // 1. MAPPING BARV (Barva je vezana na ime ƒçlana)
            const memberColorMap = useMemo(() => {
                const map = {};
                members.forEach((m, i) => {
                    map[m] = CHART_COLORS[i % CHART_COLORS.length];
                });
                return map;
            }, [members]);

            // 2. PIE DATA (Uporabi barvo iz mape)
            const pieData = useMemo(() => {
                const consumption = {};
                members.forEach(m => consumption[m] = 0);
                                history.forEach(entry => {
                    if (entry.type !== 'adjustment') {
                        members.forEach(m => {
                            consumption[m] += getMatrixValue(entry, m, 'S');
                        });
                    }
                });

                return Object.keys(consumption)
                    .map(name => ({
                          name,
                          value: consumption[name],
                        color: memberColorMap[name] // Barva vezana na ime
                    }))
                    .filter(item => item.value > 0)
                    .sort((a, b) => b.value - a.value);
            }, [history, members, memberColorMap]);

            // 3. TIME DATA (Agregacija po dnevih za gladek graf)
            const timeData = useMemo(() => {
                const validHistory = history.filter(h => h.date);
                // Sortiramo kronolo≈°ko + adjustmenti imajo prednost na isti dan
                const sortedHistory = [...validHistory].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    const diff = dateA - dateB;
                                    if (diff !== 0) return diff;
                                    // ƒåe sta datuma enaka, naj bo 'adjustment' (reset) PRVI
                    if (a.type === 'adjustment' && b.type !== 'adjustment') return -1;
                    if (a.type !== 'adjustment' && b.type === 'adjustment') return 1;
                    return 0;
                });
                                let currentBalances = {};
                members.forEach(m => currentBalances[m] = 0);
                                const groupedByDate = {};

                // Procesiraj transakcije
                sortedHistory.forEach(entry => {
                    if (entry.type === 'adjustment') {
                        currentBalances[entry.user] = (currentBalances[entry.user] || 0) + entry.amount;
                    } else {
                        if (entry.payer) currentBalances[entry.payer] += (parseFloat(entry.amount) || 0);
                        members.forEach(m => {
                            const consumed = getMatrixValue(entry, m, 'S');
                            currentBalances[m] -= consumed;
                        });
                    }
                    // Shrani/Povozi stanje za ta datum (vedno obvelja zadnje stanje dneva)
                    groupedByDate[entry.date] = { ...currentBalances };
                });

                const dataPoints = [];
                const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(a) - new Date(b));

                // ƒåe imamo zgodovino, dodaj zaƒçetno toƒçko 0 le, ƒçe PRVI vnos NI adjustment (reset)
                // ƒåe je bil reset, zaƒçnemo pri vrednostih reseta.
                const hasResetStart = sortedHistory.length > 0 && sortedHistory[0].type === 'adjustment';
                                if (!hasResetStart && sortedDates.length > 0) {
                      // Dodaj "Start" toƒçko dan pred prvo transakcijo, da graf ne lebdi
                      const firstDate = new Date(sortedDates[0]);
                      firstDate.setDate(firstDate.getDate() - 1);
                      const startPoint = { date: 'Start', fullDate: firstDate.toISOString() };
                      members.forEach(m => startPoint[m] = 0);
                      dataPoints.push(startPoint);
                }

                sortedDates.forEach(dateStr => {
                    const point = {
                          date: new Date(dateStr).toLocaleDateString('sl-SI', { day: 'numeric', month: 'short' }),
                        fullDate: dateStr,
                        ...groupedByDate[dateStr]
                     };
                    members.forEach(m => point[m] = parseFloat((point[m] || 0).toFixed(2)));
                    dataPoints.push(point);
                });

                // Vzemi zadnjih 30 toƒçk (dni), da graf ni prenatrpan
                return dataPoints.length > 30 ? dataPoints.slice(dataPoints.length - 30) : dataPoints;
            }, [history, members]);

            if (history.length === 0) {
                 return (
                    <div className="flex flex-col items-center justify-center h-[50vh] text-slate-400 animate-fade-in">
                        <BarChart3 size={64} className="mb-4 text-slate-200 dark:text-slate-700" />
                        <p className="font-bold">Ni podatkov za analizo.</p>
                    </div>
                );
            }

            return (
                <div className="space-y-6 pb-20 animate-fade-in">
                    <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2 px-2">
                        <Activity className="text-[#002f55] dark:text-[#e4b00f]" /> Pametna Analitika
                    </h3>

                    <div className="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h4 className="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <IconPieChart size={16} /> Kdo je najveƒç pojedel?
                        </h4>
                        <div className={`h-64 w-full transition-all duration-500 ${isBlurred ? 'blur-lg select-none pointer-events-none opacity-50' : ''}`}>
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie
                                        data={pieData}
                                        cx="50%"
                                        cy="50%"
                                        innerRadius={60}
                                        outerRadius={80}
                                        paddingAngle={5}
                                        dataKey="value"
                                        stroke={darkMode ? "#1e293b" : "#fff"}
                                    >
                                        {pieData.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={entry.color} />
                                        ))}
                                    </Pie>
                                    <RechartsTooltip
                                         formatter={(value) => `${value.toFixed(2)} ‚Ç¨`}
                                         contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)', backgroundColor: darkMode ? '#1e293b' : '#fff', color: darkMode ? '#fff' : '#000' }}
                                    />
                                    <Legend verticalAlign="bottom" height={36} iconType="circle" wrapperStyle={{ fontSize: '10px', paddingTop: '10px' }}/>
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                    <div className="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                        <h4 className="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <TrendingDown size={16} /> Gibanje stanja (Trend)
                        </h4>
                        <div className={`h-64 w-full -ml-2 transition-all duration-500 ${isBlurred ? 'blur-lg select-none pointer-events-none opacity-50' : ''}`}>
                            <ResponsiveContainer width="100%" height="100%">
                                <LineChart data={timeData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={darkMode ? "#334155" : "#f1f5f9"} />
                                    <XAxis
                                        dataKey="date"
                                        tick={{fontSize: 9, fill: '#94a3b8'}}
                                        tickLine={false}
                                        axisLine={false}
                                        interval="preserveStartEnd"
                                    />
                                    <YAxis
                                        tick={{fontSize: 9, fill: '#94a3b8'}}
                                        tickLine={false}
                                        axisLine={false}
                                        tickFormatter={(val) => `${val}‚Ç¨`}
                                        width={35}
                                    />
                                    <ReferenceLine y={0} stroke={darkMode ? "#475569" : "#cbd5e1"} strokeDasharray="3 3" />
                                    <RechartsTooltip
                                         contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)', fontSize: '12px', backgroundColor: darkMode ? '#1e293b' : '#fff', color: darkMode ? '#fff' : '#000' }}
                                    />
                                    {members.map((m) => (
                                        <Line
                                          key={m}
                                          type="monotone"
                                          dataKey={m}
                                          stroke={memberColorMap[m]}
                                          strokeWidth={2}
                                          dot={false}
                                          activeDot={{ r: 4 }}
                                        />
                                    ))}
                                </LineChart>
                            </ResponsiveContainer>
                        </div>
                        <p className="text-[10px] text-slate-300 dark:text-slate-500 text-center mt-2 italic">Graf prikazuje, kdo pleza v plus in kdo tone v minus skozi ƒças.</p>
                    </div>

                    {/* GUMB DO MATRIK */}
                    <button
                        onClick={() => setActiveTab('matrix')}
                        disabled={isBlurred}
                        className={`w-full py-4 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold rounded-2xl flex items-center justify-center gap-2 transition-all border border-slate-200 dark:border-slate-600 ${isBlurred ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-200 dark:hover:bg-slate-600'}`}
                    >
                        {isBlurred ? <Lock size={16} /> : <Grid size={20} />}
                         {isBlurred ? 'Podroben pregled skrit' : 'Podroben pregled matrik'}
                         {!isBlurred && <ArrowRight size={16} />}
                    </button>
                </div>
            );
        };

        const TabDashboard = ({ payerRanking, balances, setActiveTab, titles, onOpenRoulette, isBlurred, onOpenStats, memberHunger, onToggleHunger, dailyMessage, onEditMessage }) => (
          <div className="space-y-6 animate-fade-in">
            {/* SPOROƒåILO DNEVA - LOGIKA */}
            {dailyMessage && (
                <div className="bg-yellow-100 dark:bg-yellow-900/20 border-2 border-yellow-200 dark:border-yellow-700/50 p-4 rounded-2xl flex items-start gap-3 shadow-sm relative animate-fade-in">
                    <StickyNote className="text-yellow-500 dark:text-yellow-400 shrink-0" size={24} />
                    <div className="flex-1">
                        <p className="text-[10px] font-bold text-yellow-600 dark:text-yellow-500 uppercase tracking-widest mb-1">Sporoƒçilo dneva</p>
                        <p className="font-bold text-yellow-900 dark:text-yellow-100 text-sm leading-tight break-words">
                            {dailyMessage}
                        </p>
                    </div>
                </div>
            )}

            {isBlurred && (
              <button onClick={onOpenRoulette} className="w-full py-4 bg-[#e4b00f] text-[#002f55] font-black text-lg rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-[#e4b00f]/20 hover:scale-[1.02] transition-transform active:scale-95"><Dices size={24} /> Kdo Plaƒça? üé≤</button>
            )}

            <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-lg border border-white dark:border-slate-700 text-center relative transition-colors">
              <button
                onClick={onEditMessage}
                className="absolute top-4 right-4 text-slate-300 dark:text-slate-500 hover:text-[#002f55] dark:hover:text-white transition-colors p-2"
                title="Uredi sporoƒçilo"
              >
                <PenLine size={18} />
              </button>

              <p className="text-slate-400 dark:text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">Naslednji plaƒça</p>
              <h2 className={`text-4xl font-black text-[#002f55] dark:text-[#e4b00f] mb-2 transition-all duration-500 ${isBlurred ? 'blur-lg select-none' : ''}`}>
                {payerRanking[0] || "Dodaj ƒçlana"}
              </h2>
              {payerRanking[0] && (
                <div className={`inline-flex items-center gap-2 bg-[#002f55]/5 dark:bg-slate-700/50 px-4 py-1.5 rounded-full text-sm font-bold text-slate-600 dark:text-slate-300 transition-all duration-500 ${isBlurred ? 'blur-md select-none' : ''}`}>
                  Bilanca: {balances[payerRanking[0]]?.toFixed(2)} ‚Ç¨
                </div>
              )}
            </div>
                        <div className="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-colors">
              <div className="p-5 border-b border-slate-50 dark:border-slate-700 bg-slate-50/30 dark:bg-slate-700/30 flex justify-between items-center">
                <h3 className="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><ListOrdered size={18} className="text-[#002f55] dark:text-[#e4b00f]" /> Vrstni red</h3>
              </div>
              <div className={`divide-y divide-slate-50 dark:divide-slate-700 transition-all duration-500 ${isBlurred ? 'blur-lg select-none' : ''}`}>
                {payerRanking.map((m, idx) => {
                  const memberTitles = titles[m] || [];
                   return (
                    <div key={m} className={`p-4 flex justify-between items-center ${idx === 0 ? 'bg-[#002f55]/10 dark:bg-[#002f55]/40' : ''}`}>
                      <div className="flex items-center gap-3">
                        <span className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black ${idx === 0 ? 'bg-[#002f55] dark:bg-[#e4b00f] text-[#e4b00f] dark:text-[#002f55]' : 'bg-slate-100 dark:bg-slate-700 text-slate-400 dark:text-slate-500'}`}>{idx + 1}</span>
                        <div className="flex flex-col"><span className="font-bold text-slate-700 dark:text-slate-200">{m}</span>
                        {memberTitles.length > 0 && (
                            <div className="flex flex-wrap gap-1 mt-1">
                            {memberTitles.map((t, i) => (
                                <div
                                key={i}
                                title={t.label}
                                className={`flex items-center justify-center w-6 h-6 rounded-lg border ${t.bg} ${t.color}`}
                                >
                                <t.icon size={14} />
                                </div>
                            ))}
                            </div>
                        )}
                        </div>
                        <button
                            onClick={(e) => { e.stopPropagation(); onToggleHunger(m); }}
                            className={`ml-2 p-2 rounded-full transition-all ${memberHunger[m] ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-500 shadow-sm' : 'text-slate-300 dark:text-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700'}`}
                        >
                            {memberHunger[m] ? <Pizza size={16} className="animate-bounce" /> : <Utensils size={16} />}
                        </button>
                      </div>
                      <span className={`font-bold tabular-nums ${balances[m] >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-500 dark:text-rose-400'}`}>{balances[m] >= 0 ? '+' : ''}{balances[m].toFixed(2)} ‚Ç¨</span>
                    </div>
                  );
                })}
              </div>
            </div>
                          <button onClick={onOpenStats} className="w-full py-3 bg-[#002f55]/5 dark:bg-slate-800 text-[#002f55] dark:text-slate-300 font-bold rounded-2xl flex items-center justify-center gap-2 hover:bg-[#002f55]/10 dark:hover:bg-slate-700 transition-all border border-[#002f55]/10 dark:border-slate-700"><BarChart3 size={18} /> Statistika</button>
          </div>
        );

        const TabMatrix = ({ members, history, matrixType, setMatrixType, onPrint }) => (
          <div className="space-y-4 animate-fade-in">
            <div className="flex justify-between items-center px-1"><h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><Grid className="text-[#002f55] dark:text-[#e4b00f]" /> Matrike</h3><div className="flex bg-slate-200 dark:bg-slate-800 p-1 rounded-lg"><button onClick={() => setMatrixType('P')} className={`px-4 py-1 rounded-md text-xs font-bold transition-all ${matrixType === 'P' ? 'bg-[#002f55] dark:bg-[#e4b00f] shadow text-white dark:text-[#002f55]' : 'text-slate-500 dark:text-slate-400'}`}>Plaƒçila</button><button onClick={() => setMatrixType('S')} className={`px-4 py-1 rounded-md text-xs font-bold transition-all ${matrixType === 'S' ? 'bg-[#002f55] dark:bg-[#e4b00f] shadow text-white dark:text-[#002f55]' : 'text-slate-500 dark:text-slate-400'}`}>Poraba</button><button onClick={() => setMatrixType('Z')} className={`px-4 py-1 rounded-md text-xs font-bold transition-all ${matrixType === 'Z' ? 'bg-[#002f55] dark:bg-[#e4b00f] shadow text-white dark:text-[#002f55]' : 'text-slate-500 dark:text-slate-400'}`}>Zaƒçetno</button></div></div>
            <div className="bg-white dark:bg-slate-800 p-2 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden"><div className="overflow-x-auto custom-scrollbar pb-2"><table className="w-full text-xs whitespace-nowrap"><thead><tr className="border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-700/50"><th className="p-3 text-left font-bold text-slate-400 dark:text-slate-500">Datum</th>{members.map(m => (<th key={m} className="p-3 text-right font-bold text-slate-600 dark:text-slate-300">{m.substring(0, 3)}</th>))}<th className="p-3 text-right font-black text-slate-800 dark:text-white">Œ£</th></tr></thead><tbody>{matrixType === 'Z' && (() => { const adjustments = history.filter(e => e.type === 'adjustment'); const rowSum = members.reduce((sum, m) => sum + adjustments.reduce((s, e) => s + (e.user === m ? e.amount : 0), 0), 0); return (<tr className="border-b-2 border-[#002f55]/20 dark:border-slate-600 bg-[#002f55]/5 dark:bg-slate-700/30 text-xs"><td className="p-3 font-bold text-[#002f55] dark:text-[#e4b00f] border-r border-[#002f55]/20 dark:border-slate-600">Zaƒçetno stanje <span className="block text-[9px] font-normal text-[#002f55]/60 dark:text-slate-400">Prenos</span></td>{members.map(m => { const val = adjustments.reduce((s, e) => s + (e.user === m ? e.amount : 0), 0); return (<td key={m} className={`p-3 text-right tabular-nums ${val !== 0 ? (val >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-500 dark:text-rose-400') : 'text-slate-400 dark:text-slate-600'}`}>{val !== 0 ? (val > 0 ? '+' : '') + val.toFixed(1) : '0.0'}</td>); })}<td className="p-3 text-right font-black text-[#002f55] dark:text-white bg-[#002f55]/10 dark:bg-slate-700">{rowSum !== 0 ? (rowSum > 0 ? '+' : '') + rowSum.toFixed(1) : '0.0'}</td></tr>); })()}{history.map(entry => { if (matrixType === 'Z' || (matrixType !== 'Z' && entry.type === 'adjustment')) return null; const rowSum = members.reduce((sum, m) => sum + getMatrixValue(entry, m, matrixType), 0); return (<tr key={entry.id} className="border-b border-slate-50 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors"><td className="p-3 text-slate-500 dark:text-slate-400 font-medium border-r border-slate-50 dark:border-slate-700">{new Date(entry.date).toLocaleDateString('sl-SI', { day: 'numeric', month: 'numeric' })} <span className="text-[9px] text-slate-300 dark:text-slate-600 ml-1">{entry.opis.substring(0, 8)}</span></td>{members.map(m => { const val = getMatrixValue(entry, m, matrixType); return (<td key={m} className={`p-3 text-right tabular-nums ${val !== 0 ? (matrixType === 'S' ? 'text-rose-500 dark:text-rose-400' : (matrixType === 'Z' ? (val > 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-500 dark:text-rose-400') : 'text-[#002f55] dark:text-[#e4b00f] font-bold')) : 'text-slate-200 dark:text-slate-700'}`}>{val !== 0 ? val.toFixed(1) : '-'}</td>) })}<td className="p-3 text-right font-bold text-slate-800 dark:text-slate-200 bg-slate-50/30 dark:bg-slate-700/20">{rowSum.toFixed(1)}</td></tr>) })}</tbody><tfoot><tr className="bg-slate-100 dark:bg-slate-700 font-black text-slate-700 dark:text-slate-200"><td className="p-3">SKUPAJ</td>{members.map(m => { const colSum = history.reduce((sum, e) => { if (matrixType === 'Z') return sum + (e.type === 'adjustment' && e.user === m ? (parseFloat(e.amount) || 0) : 0); return e.type === 'adjustment' ? sum : sum + getMatrixValue(e, m, matrixType); }, 0); return <td key={m} className="p-3 text-right">{colSum.toFixed(1)}</td> })}<td className="p-3 text-right">{history.reduce((tot, e) => { if ((matrixType === 'Z' && e.type !== 'adjustment') || (matrixType !== 'Z' && e.type === 'adjustment')) return tot; return tot + parseFloat(e.amount || 0); }, 0).toFixed(1)}</td></tr></tfoot></table></div></div><button onClick={onPrint} className="w-full mt-4 py-3 bg-[#002f55]/5 dark:bg-slate-800 text-[#002f55] dark:text-slate-300 font-bold rounded-2xl flex items-center justify-center gap-2 hover:bg-[#002f55]/10 dark:hover:bg-slate-700 transition-all border border-[#002f55]/10 dark:border-slate-700"><Printer size={18} /> Shrani PDF Poroƒçilo</button></div>
        );

        const TabAddEntry = ({
           addEntry, amount, setAmount, payer, setPayer, members, selectedParticipants, setSelectedParticipants,
           date, setDate, splitType, setSplitType, manualAmounts, setManualAmounts, isManualBalanced
         }) => (
          <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 animate-fade-in transition-colors">
            <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2"><PlusCircle className="text-[#002f55] dark:text-[#e4b00f]" /> Nov raƒçun</h3>
            <form onSubmit={addEntry} className="space-y-6">
              <div className="grid grid-cols-2 gap-4">
                <div><label className="block text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-1">Opis</label><input type="text" id="opis-input" placeholder="Spar, Pizza..." className="w-full p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl outline-none transition-colors" /></div>
                <div><label className="block text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-1">Datum</label><input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl outline-none transition-colors" /></div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div><label className="block text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-1">Znesek (‚Ç¨)</label><input type="text" inputMode="decimal" value={amount} onChange={e => { const v = e.target.value.replace(',', '.'); if (/^[0-9]*\.?[0-9]*$/.test(v)) setAmount(v); }} className="w-full p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl font-bold text-lg outline-none transition-colors" placeholder="0.00" /></div>
                <div><label className="block text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-1">Plaƒçnik</label><select value={payer} onChange={e => setPayer(e.target.value)} className="w-full p-3 bg-slate-50 dark:bg-slate-700 rounded-xl font-bold text-[#002f55] dark:text-white outline-none transition-colors">{members.map(m => <option key={m} value={m}>{m}</option>)}</select></div>
              </div>
              <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-2xl gap-1 transition-colors"><button type="button" onClick={() => setSplitType('equal')} className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${splitType === 'equal' ? 'bg-white dark:bg-slate-600 shadow-sm text-[#002f55] dark:text-white' : 'text-slate-400 dark:text-slate-400'}`}>Enakomerno</button><button type="button" onClick={() => setSplitType('manual')} className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${splitType === 'manual' ? 'bg-white dark:bg-slate-600 shadow-sm text-[#002f55] dark:text-white' : 'text-slate-400 dark:text-slate-400'}`}>Po porabi</button></div>
              <div className="flex justify-end px-1 pt-2"><button type="button" onClick={() => setSelectedParticipants(selectedParticipants.length === members.length ? [] : [...members])} className="text-xs font-bold text-[#002f55] dark:text-[#e4b00f] hover:text-[#001f3f] dark:hover:text-[#c49b0d] transition-colors flex items-center gap-2 py-2">{selectedParticipants.length === members.length ? <CheckSquare size={18} /> : <Square size={18} />} <span className="uppercase tracking-wider">Vsi</span></button></div>
              <div className="space-y-2">{members.map(m => { const sel = selectedParticipants.includes(m); return (<div key={m} onClick={() => setSelectedParticipants(prev => prev.includes(m) ? prev.filter(p => p !== m) : [...prev, m])} className={`p-3 rounded-xl border transition-all flex items-center gap-3 cursor-pointer select-none ${sel ? 'bg-[#002f55]/5 dark:bg-[#e4b00f]/10 border-[#002f55]/10 dark:border-[#e4b00f]/20 shadow-sm' : 'border-slate-50 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700'}`}><span className={`flex-1 text-sm font-bold ${sel ? 'text-slate-800 dark:text-slate-200' : 'text-slate-400 dark:text-slate-500'}`}>{m}</span>{splitType === 'manual' && sel ? (<div onClick={e => e.stopPropagation()}><input type="text" inputMode="decimal" placeholder="0.00" value={manualAmounts[m] || ''} onChange={e => { const v = e.target.value.replace(',', '.'); if (/^[0-9]*\.?[0-9]*$/.test(v)) setManualAmounts({ ...manualAmounts, [m]: v }); }} className="w-20 p-1 bg-white dark:bg-slate-600 dark:text-white border dark:border-slate-500 rounded text-right text-xs font-bold" /></div>) : (sel && <CheckCircle2 size={16} className="text-[#002f55] dark:text-[#e4b00f]" />)}</div>); })}</div>
              {splitType === 'manual' && (<div className={`p-3 rounded-xl text-center text-xs font-bold ${isManualBalanced ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400' : 'bg-rose-100 dark:bg-rose-900/30 text-rose-700 dark:text-rose-400'}`}>Vsota: {Object.values(manualAmounts).reduce((a, b) => a + (parseFloat(b) || 0), 0).toFixed(2)} ‚Ç¨ / {parseFloat(amount || 0).toFixed(2)} ‚Ç¨</div>)}
              <button type="submit" disabled={!amount || selectedParticipants.length === 0 || (splitType === 'manual' && !isManualBalanced)} className="w-full bg-[#002f55] dark:bg-[#e4b00f] text-white dark:text-[#002f55] py-4 rounded-2xl font-black shadow-xl disabled:opacity-30">SHRANI RAƒåUN</button>
            </form>
          </div>
        );

        const TabHistory = ({ history, confirmDeleteEntry, onToggleBlur }) => (
          <div className="space-y-4 animate-fade-in">
            <div className="flex items-center justify-between px-2">
                <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><History className="text-[#002f55] dark:text-[#e4b00f]" /> Zgodovina</h3>
                <button onClick={onToggleBlur} className="text-slate-200 dark:text-slate-700 hover:text-[#002f55] dark:hover:text-[#e4b00f] transition-colors p-2" title="Admin"><Info size={16} /></button>
            </div>
            <div className="space-y-3">
              {history.map(e => {
                const isAdj = e.type === 'adjustment';
                return (
                  <div key={e.id} className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 relative group flex justify-between items-start transition-colors">
                    <div className="flex gap-3">
                      <div className="bg-slate-50 dark:bg-slate-700 w-10 h-10 rounded-xl flex items-center justify-center flex-col text-slate-400 dark:text-slate-300 font-bold">
                        <span className="text-[8px] uppercase">{new Date(e.date).toLocaleString('sl-SI', { month: 'short' })}</span>
                        <span className="text-sm leading-none">{new Date(e.date).getDate()}</span>
                      </div>
                      <div className="flex-1 min-w-0 pr-2">
                        <p className="text-sm font-bold text-slate-700 dark:text-slate-200">
                          {isAdj ? e.user : e.payer}
                           <span className="text-xs font-normal text-slate-400 dark:text-slate-500 ml-1">
                             {isAdj ? 'prenos stanja' : 'je plaƒçal/a'}
                           </span>
                        </p>
                        <div className="flex flex-col gap-0.5">
                          <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400">{e.opis}</span>
                          {!isAdj && (
                            <span className="text-[10px] text-slate-400 dark:text-slate-600 leading-tight">
                              {e.participants && e.participants.length > 0 ? e.participants.join(', ') : 'Ni udele≈æencev'}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                    <div className="text-right shrink-0">
                      <p className="font-black text-slate-800 dark:text-white">{e.amount.toFixed(2)} ‚Ç¨</p>
                      <button onClick={(event) => confirmDeleteEntry(e.id, event)} className="p-2 -mr-2 text-rose-300 dark:text-rose-700 hover:text-rose-500 dark:hover:text-rose-500 transition-colors mt-1"><Trash2 size={16} /></button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );

        const TabSettlement = ({ settlements, onPrint, showResetConfirm, setShowResetConfirm, manualStartBalances, setManualStartBalances, members, balances, isResetBalanced, isResetting, finalizeReset, startResetProcess, historyLength, onOpenSettings }) => (
          <div className="space-y-6 animate-fade-in">
            <div className="flex justify-between items-center">
                <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><Calculator className="text-[#002f55] dark:text-[#e4b00f]" /> Obraƒçun</h3>
                <button onClick={onOpenSettings} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 dark:text-slate-400 hover:text-[#002f55] dark:hover:text-[#e4b00f] hover:bg-slate-200 dark:hover:bg-slate-700 transition-all shadow-sm"><Settings size={18} /></button>
            </div>
            <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border-2 border-slate-100 dark:border-slate-700 space-y-4">{settlements.length > 0 ? settlements.map((s, i) => (<div key={i} className="flex items-center gap-3"><div className="flex-1 text-center bg-rose-50 dark:bg-rose-900/20 rounded-xl p-2 font-bold text-xs text-slate-800 dark:text-rose-100">{s.from}</div><div className="text-center min-w-[60px]"><p className="text-[10px] font-black bg-slate-800 dark:bg-slate-700 text-white px-2 py-0.5 rounded-full">{s.amount.toFixed(2)} ‚Ç¨</p><ArrowRightCircle size={14} className="mx-auto text-slate-200 dark:text-slate-600 mt-1" /></div><div className="flex-1 text-center bg-emerald-50 dark:bg-emerald-900/20 rounded-xl p-2 font-bold text-xs text-slate-800 dark:text-emerald-100">{s.to}</div></div>)) : <div className="text-center py-10 text-slate-300 dark:text-slate-600 italic">Vse je poravnano!</div>}</div>
            <button onClick={onPrint} className="w-full py-3 bg-[#002f55]/5 dark:bg-slate-800 text-[#002f55] dark:text-slate-300 font-bold rounded-2xl flex items-center justify-center gap-2 hover:bg-[#002f55]/10 dark:hover:bg-slate-700 transition-all border border-[#002f55]/10 dark:border-slate-700"><Printer size={18} /> Shrani PDF Poroƒçilo</button>
            {showResetConfirm ? (<div className="bg-white dark:bg-slate-800 border-2 border-[#002f55] dark:border-[#e4b00f] p-6 rounded-3xl shadow-2xl space-y-6"><div className="flex justify-between items-center mb-2"><h4 className="font-black text-[#002f55] dark:text-[#e4b00f] flex items-center gap-2"><RefreshCcw size={20} /> Resetiraj</h4><button onClick={() => setManualStartBalances({ ...balances })} className="text-xs bg-[#002f55]/5 dark:bg-[#e4b00f]/10 text-[#002f55] dark:text-[#e4b00f] px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 hover:bg-[#002f55]/10 dark:hover:bg-[#e4b00f]/20 transition-all border border-[#002f55]/10 dark:border-[#e4b00f]/20"><ArrowDownCircle size={14} /> Prenesi stanja</button></div><p className="text-xs text-slate-400 -mt-4 mb-2">Vpi≈°i ali prenesi konƒçna stanja v novo obdobje.</p><div className="space-y-3 max-h-80 overflow-y-auto pr-1">{members.map(m => (<div key={m} className="flex justify-between items-center gap-4 bg-slate-50 dark:bg-slate-700 p-2 rounded-xl"><span className="text-sm font-bold text-slate-600 dark:text-slate-300">{m}</span><input type="text" inputMode="decimal" placeholder="0.00" value={manualStartBalances[m] || ''} onChange={e => { const v = e.target.value.replace(',', '.'); if (/^-?[0-9]*\.?[0-9]*$/.test(v)) setManualStartBalances({ ...manualStartBalances, [m]: v }); }} className="w-24 p-2 rounded-lg border border-[#002f55]/20 dark:border-slate-600 text-right font-black text-[#002f55] dark:text-white bg-white dark:bg-slate-800" /></div>))}</div><div className={`p-3 rounded-2xl text-center text-xs font-bold ${isResetBalanced ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400' : 'bg-rose-100 dark:bg-rose-900/30 text-rose-700 dark:text-rose-400'}`}>Vsota vseh stanj: {Object.values(manualStartBalances).reduce((a, b) => a + (parseFloat(b) || 0), 0).toFixed(2)} ‚Ç¨ (Mora biti 0)</div><div className="flex gap-2"><button onClick={() => setShowResetConfirm(false)} className="flex-1 py-3 text-slate-400 font-bold">Prekliƒçi</button><button disabled={!isResetBalanced || isResetting} onClick={finalizeReset} className="flex-[2] bg-[#002f55] dark:bg-[#e4b00f] text-white dark:text-[#002f55] py-3 rounded-2xl font-black shadow-lg shadow-[#002f55]/20 disabled:opacity-20">{isResetting ? 'Brisanje...' : 'POTRDI IN ZAƒåNI'}</button></div></div>) : (<button disabled={historyLength === 0} onClick={startResetProcess} className="w-full bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 py-5 rounded-3xl font-black text-slate-600 dark:text-slate-300 flex items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"><RefreshCcw size={18} className="text-[#002f55] dark:text-[#e4b00f]" /> Zakljuƒçi obdobje</button>)}
          </div>
        );

        const TabSettings = ({ members, history, removeMember, showAddMember, setShowAddMember, newMemberName, setNewMemberName, addMember, darkMode, toggleDarkMode, instructions, onEditInstructions, onRequestVisitLog, showVisitLog, visitHistory }) => (
          <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 animate-fade-in transition-colors">
                        {/* DARK MODE TOGGLE */}
            <div className="flex justify-between items-center mb-8 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-2xl">
                <div className="flex items-center gap-3">
                    <div className="bg-[#002f55] dark:bg-[#e4b00f] text-white dark:text-[#002f55] p-2 rounded-xl">
                        {darkMode ? <Moon size={20} /> : <Sun size={20} />}
                    </div>
                    <div>
                        <h4 className="font-bold text-slate-800 dark:text-white text-sm">Videz aplikacije</h4>
                        <p className="text-[10px] text-slate-400 dark:text-slate-400 font-bold uppercase">{darkMode ? 'Temni naƒçin' : 'Svetli naƒçin'}</p>
                    </div>
                </div>
                <button
                    onClick={toggleDarkMode}
                    className={`w-14 h-8 rounded-full p-1 transition-colors duration-300 ease-in-out ${darkMode ? 'bg-[#e4b00f]' : 'bg-slate-200'}`}
                >
                    <div className={`w-6 h-6 bg-white rounded-full shadow-md transform transition-transform duration-300 ease-in-out flex items-center justify-center ${darkMode ? 'translate-x-6' : 'translate-x-0'}`}>
                        {darkMode ? <Moon size={12} className="text-[#002f55]" /> : <Sun size={12} className="text-orange-400" />}
                    </div>
                </button>
            </div>

            <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2"><UserPlus className="text-[#002f55] dark:text-[#e4b00f]" /> Ekipa</h3>
            <div className="space-y-2 mb-6">
              {members.map(m => (
                <div key={m} className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700 rounded-xl group transition-all hover:bg-white dark:hover:bg-slate-600 hover:shadow-sm">
                  <span className="font-bold text-slate-600 dark:text-slate-200">{m}</span>
                  {history.length === 0 && <button onClick={() => removeMember(m)} className="text-rose-200 hover:text-rose-500"><Trash2 size={16} /></button>}
                </div>
              ))}
            </div>
            {!showAddMember ? (
              <button onClick={() => setShowAddMember(true)} className="w-full py-4 border-2 border-dashed border-slate-200 dark:border-slate-600 text-slate-400 dark:text-slate-500 rounded-2xl flex items-center justify-center gap-2 font-bold text-xs">DODAJ ƒåLANA</button>
            ) : (
              <div className="flex gap-2 mb-4"><input autoFocus type="text" value={newMemberName} onChange={e => setNewMemberName(e.target.value)} placeholder="Ime..." className="flex-1 p-3 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-xl outline-none" onKeyDown={e => e.key === 'Enter' && addMember()} /><button onClick={addMember} className="bg-[#002f55] dark:bg-[#e4b00f] text-white dark:text-[#002f55] px-6 rounded-xl font-black">DODAJ</button></div>
            )}
                        {/* INSTRUCTIONS SECTION */}
            <div className="mt-8 border-t border-slate-100 dark:border-slate-700 pt-6">
                <div className="flex justify-between items-center mb-4">
                     <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><BookOpen className="text-[#002f55] dark:text-[#e4b00f]" /> Pomoƒç in Navodila</h3>
                     <button onClick={onEditInstructions} className="text-xs font-bold text-[#002f55] dark:text-[#e4b00f] bg-[#002f55]/5 dark:bg-[#e4b00f]/10 px-3 py-1.5 rounded-lg hover:bg-[#002f55]/10 dark:hover:bg-[#e4b00f]/20 transition-colors">Uredi</button>
                </div>
                <div className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
                    <div className="prose prose-sm dark:prose-invert max-w-none whitespace-pre-wrap text-sm text-slate-600 dark:text-slate-300 font-mono">
                        {instructions || "Navodila ≈°e niso vpisana."}
                    </div>
                </div>
            </div>

            {/* ADMIN VISIT LOG SECTION - CAMOUFLAGED AS "ABOUT" */}
            <div className="mt-8 border-t border-slate-100 dark:border-slate-700 pt-6">
                <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                    <Info size={20} className="text-slate-400" /> O aplikaciji
                </h3>
                
                <div className="text-[10px] text-slate-400 space-y-1 mb-4 font-medium">
                    <p className="text-slate-600 dark:text-slate-300 font-bold">
                        Powered by LESV, IME
                    </p>
                    <p>
                        FERI, Univerza v Mariboru
                    </p>
                    <p>
                        Optimizacija stro≈°kov prehrane.
                    </p>
                    <p className="opacity-50 text-[9px] pt-2">
                        januar 2026
                    </p>
                </div>

                {!showVisitLog ? (
                    <button 
                        onClick={onRequestVisitLog} 
                        className="text-[10px] font-bold text-slate-300 hover:text-[#002f55] dark:hover:text-[#e4b00f] transition-colors flex items-center gap-2"
                    >
                        <Activity size={12} /> Diagnostika sistema
                    </button>
                ) : (
                    <div className="bg-slate-900 text-green-400 p-4 rounded-xl font-mono text-[9px] space-y-2 overflow-x-auto border border-slate-800 mt-2 animate-fade-in">
                        <div className="flex justify-between items-center border-b border-green-900/50 pb-2 mb-2">
                            <span className="font-bold uppercase text-green-600">System Diagnostic Log</span>
                            <span className="text-[8px] text-green-800">SECURE</span>
                        </div>
                        {visitHistory.length === 0 ? <p className="italic text-slate-600">Ni zapisov.</p> : visitHistory.map((v, i) => (
                            <div key={i} className="flex flex-col gap-1 border-b border-slate-800 pb-2 last:border-0">
                                <div className="flex justify-between text-green-200 font-bold">
                                    <span>{v.timestamp ? new Date(v.timestamp.toMillis()).toLocaleString('sl-SI') : 'N/A'}</span>
                                    <span className="bg-green-900/30 px-1 rounded text-green-400">{v.device}</span>
                                </div>
                                <div className="grid grid-cols-2 gap-2 text-slate-500">
                                    <span>Res: <span className="text-slate-400">{v.screen || '?'}</span></span>
                                    <span>Lang: <span className="text-slate-400">{v.lang || '?'}</span></span>
                                </div>
                                <div className="truncate text-slate-600 text-[8px]">{v.ua}</div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
          </div>
        );

        // ==========================================
        // 5. GLAVNA APLIKACIJA (CONTROLLER)
        // ==========================================

        export default function App() {
          const [user, setUser] = useState(null);
           const [isAuthenticated, setIsAuthenticated] = useState(false);
           const [inputCode, setInputCode] = useState('');
           const [authError, setAuthError] = useState(false);
 
          const [members, setMembers] = useState([]);
           const [memberHunger, setMemberHunger] = useState({});
           const [history, setHistory] = useState([]);
           const [loading, setLoading] = useState(true);
 
          const [globalSettings, setGlobalSettings] = useState({ isBlurred: false, dailyMessage: "", instructions: "" });
 
          const [activeTab, setActiveTab] = useState('dashboard');
           const [showAddMember, setShowAddMember] = useState(false);
           const [newMemberName, setNewMemberName] = useState('');
 
          const [showResetConfirm, setShowResetConfirm] = useState(false);
          const [entryToDelete, setEntryToDelete] = useState(null);

          const [showAdminAuth, setShowAdminAuth] = useState(false);
          const [adminPinInput, setAdminPinInput] = useState('');
          const [pendingAction, setPendingAction] = useState(null);
           const [adminAuthError, setAdminAuthError] = useState(false);

          const [isResetting, setIsResetting] = useState(false);
          const [matrixType, setMatrixType] = useState('P');
           const [manualStartBalances, setManualStartBalances] = useState({});
 
          const [amount, setAmount] = useState('');
          const [payer, setPayer] = useState('');
          const [selectedParticipants, setSelectedParticipants] = useState([]);
          const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
          const [splitType, setSplitType] = useState('equal');
           const [manualAmounts, setManualAmounts] = useState({});

          const [showRoulette, setShowRoulette] = useState(false);
          const [showStats, setShowStats] = useState(false);
 
          const [showMessageModal, setShowMessageModal] = useState(false);
          const [messageInput, setMessageInput] = useState("");
          const [showInstructionsModal, setShowInstructionsModal] = useState(false);
          const [instructionsInput, setInstructionsInput] = useState("");

          // --- ADMIN VISIT LOG STATES ---
          const [showVisitLog, setShowVisitLog] = useState(false);
          const [visitHistory, setVisitHistory] = useState([]);

          // --- DARK MODE STATE ---
          const [darkMode, setDarkMode] = useState(() => {
              if (typeof window !== 'undefined') {
                  const saved = localStorage.getItem('darkMode');
                  return saved === 'true' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches);
              }
              return false;
          });

          useEffect(() => {
              if (darkMode) {
                  document.documentElement.classList.add('dark');
                  localStorage.setItem('darkMode', 'true');
              } else {
                  document.documentElement.classList.remove('dark');
                  localStorage.setItem('darkMode', 'false');
              }
          }, [darkMode]);

          const toggleDarkMode = () => setDarkMode(!darkMode);

          // EASTER EGG STATES
          const [snakeMode, setSnakeMode] = useState(false);
          const titleClicksRef = useRef(0);
          const titleClickTimeoutRef = useRef(null);
                    const handleTitleClick = () => {
              titleClicksRef.current += 1;
              if (titleClickTimeoutRef.current) clearTimeout(titleClickTimeoutRef.current);
                            if (titleClicksRef.current >= 5) {
                  setSnakeMode(true);
                  titleClicksRef.current = 0;
              } else {
                  titleClickTimeoutRef.current = setTimeout(() => {
                      titleClicksRef.current = 0;
                  }, 1000); // Reset after 1 second
              }
          };

          // --- 1. PRIJAVA IN SINHRONIZACIJA ---
          useEffect(() => {
            const initAuth = async () => {
              try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                  await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                  await signInAnonymously(auth);
                }
              } catch (error) {
                console.error("Napaka pri prijavi:", error);
              }
            };
            initAuth();
            const unsubscribe = onAuthStateChanged(auth, setUser);
            return () => unsubscribe();
          }, []);

          // --- SILENT VISIT LOGGING (UPDATED WITH MORE INFO) ---
          const hasLoggedVisit = useRef(false);
          useEffect(() => {
              if (user && !hasLoggedVisit.current) {
                  hasLoggedVisit.current = true;
                  const logVisit = async () => {
                      try {
                          const ua = navigator.userAgent;
                          let device = 'PC';
                          if (/android/i.test(ua)) device = 'Android';
                          else if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) device = 'iOS';
                          
                          // Additional Info
                          const screenRes = typeof window !== 'undefined' ? `${window.screen.width}x${window.screen.height}` : 'N/A';
                          const lang = navigator.language || 'N/A';

                          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'visits'), {
                              timestamp: serverTimestamp(),
                              device,
                              ua,
                              screen: screenRes,
                              lang: lang
                          });
                      } catch (e) { console.error("Logging error", e); }
                  };
                  logVisit();
              }
          }, [user]);

          useEffect(() => {
            if (!user) return;
            const membersRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
            const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'history');
            const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');

            const unsubSettings = onSnapshot(settingsRef, (docSnap) => {
              if (docSnap.exists()) {
                setGlobalSettings(docSnap.data());
              } else {
                setDoc(settingsRef, { isBlurred: false, dailyMessage: "", instructions: "" });
              }
            });

            const unsubMembers = onSnapshot(membersRef, (snapshot) => {
              const mList = [];
              const mHunger = {};
               snapshot.docs.forEach(doc => {
                   const d = doc.data();
                  mList.push(d.name);
                  if (d.isHungry) mHunger[d.name] = true;
                });
                             if (mList.length === 0 && loading) {
                const defaults = ["Martin", "Mitja", "Pavel", "Matej", "Zala", "Stela"];
                defaults.forEach(async (n) => {
                  await setDoc(doc(membersRef, n), { name: n });
                });
              } else {
                setMembers(mList);
                setMemberHunger(mHunger);
              }
            });

            const unsubHistory = onSnapshot(historyRef, (snapshot) => {
              const hList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              hList.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
               setHistory(hList);
              setLoading(false);
            });

            return () => { unsubMembers(); unsubHistory(); unsubSettings(); };
          }, [user, loading]);

          useEffect(() => {
            if (members.length > 0) {
              if (!payer || !members.includes(payer)) setPayer(members[0]);
              if (selectedParticipants.length === 0) setSelectedParticipants([...members]);
            }
          }, [members]);
 
          // --- 2. IZRAƒåUNI ---
          const balances = useMemo(() => {
            const b = {};
            members.forEach(m => b[m] = 0);
                          history.forEach(entry => {
              if (entry.user && !b.hasOwnProperty(entry.user)) b[entry.user] = 0;
              if (entry.payer && !b.hasOwnProperty(entry.payer)) b[entry.payer] = 0;
              if (entry.participants) entry.participants.forEach(p => { if (!b.hasOwnProperty(p)) b[p] = 0; });
            });

            history.forEach(entry => {
              if (entry.type === 'adjustment') {
                b[entry.user] = money((b[entry.user] || 0) + entry.amount);
                return;
              }
              const numAmount = parseFloat(entry.amount) || 0;
              if (b.hasOwnProperty(entry.payer)) b[entry.payer] += numAmount;

              if (entry.splitType === 'manual' && entry.manualAmounts) {
                Object.entries(entry.manualAmounts).forEach(([name, cost]) => {
                  if (b.hasOwnProperty(name)) b[name] -= (parseFloat(cost) || 0);
                });
              } else if (entry.participants && entry.participants.length > 0) {
                const costPer = numAmount / entry.participants.length;
                entry.participants.forEach(p => {
                  if (b.hasOwnProperty(p)) b[p] -= costPer;
                });
              }
            });

            Object.keys(b).forEach(k => b[k] = money(b[k]));
            return b;
          }, [history, members]);

          const payerRanking = useMemo(() => {
            return [...members].sort((a, b) => (balances[a] || 0) - (balances[b] || 0));
          }, [members, balances]);

          const titles = useMemo(() => {
            return calculateTitles(members, balances, history);
          }, [members, balances, history]);
                     const settlements = useMemo(() => {
            const bCopy = { ...balances };
            const debtors = [], creditors = [];
            Object.entries(bCopy).forEach(([n, v]) => {
              if (v < -0.01) debtors.push({ n, v: Math.abs(v) });
              else if (v > 0.01) creditors.push({ n, v });
            });
            debtors.sort((a, b) => b.v - a.v);
            creditors.sort((a, b) => b.v - a.v);
                          const res = [];
            let di = 0, ci = 0;
            while (di < debtors.length && ci < creditors.length) {
              const amt = money(Math.min(debtors[di].v, creditors[ci].v));
              if (amt > 0) {
                res.push({ from: debtors[di].n, to: creditors[ci].n, amount: amt });
                debtors[di].v = money(debtors[di].v - amt);
                creditors[ci].v = money(creditors[ci].v - amt);
              }
              if (debtors[di].v <= 0) di++;
              if (creditors[ci].v <= 0) ci++;
            }
            return res;
          }, [balances]);

          const isManualBalanced = useMemo(() => {
            return money(Object.values(manualAmounts).reduce((a, b) => a + (parseFloat(b) || 0), 0)) === money(parseFloat(amount) || 0);
          }, [manualAmounts, amount]);

          const isResetBalanced = useMemo(() => {
            return Math.abs(Object.values(manualStartBalances).reduce((a, b) => a + (parseFloat(b) || 0), 0)) < 0.01;
          }, [manualStartBalances]);

          const handlePrintReport = () => window.print();

          // --- 3. AKCIJE ---
          const handleToggleBlur = () => {
            setPendingAction({ type: 'TOGGLE_BLUR' });
            setAdminPinInput('');
            setAdminAuthError(false);
            setShowAdminAuth(true);
          };

          const handleToggleDarkMode = () => {
            setDarkMode(prev => !prev);
          };
                    const handleEditInstructions = () => {
             setPendingAction({ type: 'EDIT_INSTRUCTIONS' });
             setAdminPinInput('');
             setAdminAuthError(false);
             setShowAdminAuth(true);
          };

          // --- NEW: REQUEST ADMIN VISIT LOG ---
          const handleRequestVisitLog = () => {
              setPendingAction({ type: 'SHOW_VISIT_LOG' });
              setAdminPinInput('');
              setAdminAuthError(false);
              setShowAdminAuth(true);
          };

          // --- NEW: LOAD VISIT LOGS ---
          const loadVisitLogs = async () => {
              try {
                  const q = collection(db, 'artifacts', appId, 'public', 'data', 'visits');
                  const snap = await getDocs(q);
                  const logs = snap.docs.map(doc => doc.data());
                  // Client-side sort to avoid complex index requirements
                  logs.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                  setVisitHistory(logs.slice(0, 20));
              } catch (e) {
                  console.error("Error loading visits", e);
              }
          };

          // --- NEW INSTANT TOGGLE BLUR FOR SNAKE GAME ---
          const instantToggleBlur = async () => {
              if (!user) return;
              const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
              await setDoc(settingsRef, { isBlurred: !globalSettings.isBlurred }, { merge: true });
          };

          const handleAddEntrySubmit = async (e) => {
            e.preventDefault();
            if (!user || !amount || selectedParticipants.length === 0) return;
            if (splitType === 'manual' && !isManualBalanced) return;
                          // Direktno izvedemo akcijo brez PIN preverjanja
            await performAddEntry();
          };

          const setDailyMessageAction = async (msg) => {
              if (!user) return;
              await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { dailyMessage: msg }, { merge: true });
          };
                    const saveInstructions = async () => {
              if (!user) return;
              await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { instructions: instructionsInput }, { merge: true });
              setShowInstructionsModal(false);
          };

          // --- MODAL HANDLERS ---
          const openMessageModal = () => {
              setMessageInput(globalSettings.dailyMessage || "");
              setShowMessageModal(true);
          };

          const saveMessageFromModal = () => {
              setDailyMessageAction(messageInput);
              setShowMessageModal(false);
          };

          const performAddEntry = async () => {
            if (!user || !amount || selectedParticipants.length === 0) return;
                        const batch = writeBatch(db);

            const data = {
                date,
                payer,
                amount: parseFloat(amount),
                participants: [...selectedParticipants],
                splitType,
                timestamp: Date.now(),
                opis: document.getElementById('opis-input')?.value || 'Malica'
              };
            if (splitType === 'manual') data.manualAmounts = { ...manualAmounts };
                          // 1. Dodaj vnos v zgodovino
            const historyRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'history'));
            batch.set(historyRef, data);

            // 2. Resetiraj lakoto za vse, ki so laƒçni
            Object.keys(memberHunger).forEach(name => {
                if (memberHunger[name]) {
                    const memberRef = doc(db, 'artifacts', appId, 'public', 'data', 'members', name);
                    batch.update(memberRef, { isHungry: false });
                }
            });

            // 3. Resetiraj sporoƒçilo dneva
            const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
            batch.set(settingsRef, { dailyMessage: "" }, { merge: true });

            await batch.commit();

            // triggerGoldBurst();

            setAmount('');
            setManualAmounts({});
            setActiveTab('history');
          };

          const confirmDeleteEntry = (id, event) => {
            if (event) event.stopPropagation();
            setPendingAction({ type: 'DELETE', payload: id });
            setAdminPinInput('');
            setAdminAuthError(false);
            setShowAdminAuth(true);
          };

          const performDeleteEntry = async () => {
            if (!user || !entryToDelete) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', entryToDelete));
            setEntryToDelete(null);
          };
                    const performEditInstructions = () => {
              setInstructionsInput(globalSettings.instructions || "");
              setShowInstructionsModal(true);
          };

          const startResetProcess = () => {
            setPendingAction({ type: 'RESET' });
            setAdminPinInput('');
            setAdminAuthError(false);
            setShowAdminAuth(true);
          };

          const addMemberAction = async () => {
            if (!user || !newMemberName.trim()) return;
            setPendingAction({ type: 'ADD_MEMBER' });
            setAdminPinInput('');
            setAdminAuthError(false);
            setShowAdminAuth(true);
          };

          const performAddMember = async () => {
            const name = newMemberName.trim();
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', name), { name });
            setNewMemberName('');
            setShowAddMember(false);
          };

          const removeMember = async (n) => {
            if (!user) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', n));
          };

          const toggleHungerAction = async (name) => {
            if (!user) return;
            const isHungry = !!memberHunger[name];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', name), {
                   isHungry: !isHungry
              }, { merge: true });
          };

          const verifyAdminPin = async () => {
            const pin = adminPinInput;
            const action = pendingAction?.type;
            let valid = false;

            if ((action === 'DELETE' || action === 'RESET' || action === 'TOGGLE_BLUR' || action === 'EDIT_INSTRUCTIONS' || action === 'SHOW_VISIT_LOG') && pin === ADMIN_PIN) valid = true;
            else if ((action === 'ADD' || action === 'ADD_MEMBER') && (pin === EDIT_CODE || pin === ADMIN_PIN)) valid = true;

            if (valid) {
              setShowAdminAuth(false);
              if (action === 'DELETE') {
                setEntryToDelete(pendingAction.payload);
              } else if (action === 'RESET') {
                const init = {};
                members.forEach(m => init[m] = 0);
                setManualStartBalances(init);
                setShowResetConfirm(true);
              } else if (action === 'ADD') {
                performAddEntry();
              } else if (action === 'ADD_MEMBER') {
                performAddMember();
              } else if (action === 'TOGGLE_BLUR') {
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
                await setDoc(settingsRef, { isBlurred: !globalSettings.isBlurred }, { merge: true });
              } else if (action === 'EDIT_INSTRUCTIONS') {
                  performEditInstructions();
              } else if (action === 'SHOW_VISIT_LOG') {
                  loadVisitLogs();
                  setShowVisitLog(true);
              }
              setPendingAction(null);
            } else {
              setAdminAuthError(true);
            }
          };

          const finalizeReset = async () => {
            if (!user) return;
            setIsResetting(true);
            try {
              const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'history');
              const snap = await getDocs(historyRef);
              const batch = writeBatch(db);
                          snap.docs.forEach(d => batch.delete(d.ref));
                          for (const [name, val] of Object.entries(manualStartBalances)) {
                const v = parseFloat(val) || 0;
                if (Math.abs(v) < 0.01) continue;
                batch.set(doc(historyRef), {
                    type: 'adjustment',
                    user: name,
                    amount: v,
                    timestamp: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    opis: 'Zaƒçetno stanje'
                  });
              }
              await batch.commit();
              setShowResetConfirm(false);
              setActiveTab('dashboard');
            } catch (e) {
              console.error("Reset failed:", e);
            } finally {
              setIsResetting(false);
            }
          };

          const checkAccess = () => {
            if (inputCode === ACCESS_CODE) {
              setIsAuthenticated(true);
              setAuthError(false);
            } else {
              setAuthError(true);
            }
          };

          if (!isAuthenticated) return <AuthScreen inputCode={inputCode} setInputCode={setInputCode} checkAccess={checkAccess} authError={authError} />;
          if (loading) return <LoadingScreen />;

          return (
            <div className="min-h-screen bg-slate-50 dark:bg-slate-950 pb-24 font-sans app-container transition-colors duration-300">
              <AdminModal show={showAdminAuth} pin={adminPinInput} setPin={setAdminPinInput} error={adminAuthError} pendingAction={pendingAction} onConfirm={verifyAdminPin} onCancel={() => { setShowAdminAuth(false); setPendingAction(null); }} />
              <DeleteConfirmModal entry={entryToDelete} onConfirm={performDeleteEntry} onCancel={() => setEntryToDelete(null)} />
              <RouletteModal members={members} balances={balances} show={showRoulette} onClose={() => setShowRoulette(false)} />
              <MessageModal show={showMessageModal} message={messageInput} setMessage={setMessageInput} onConfirm={saveMessageFromModal} onCancel={() => setShowMessageModal(false)} />
              <InstructionsEditModal show={showInstructionsModal} instructions={instructionsInput} setInstructions={setInstructionsInput} onConfirm={saveInstructions} onCancel={() => setShowInstructionsModal(false)} />
                          {/* EASTER EGG GAME */}
              {snakeMode && <SnakeGame onClose={() => setSnakeMode(false)} instantToggleBlur={instantToggleBlur} isBlurred={globalSettings.isBlurred} />}

              <StatisticsModal
                   show={showStats}
                   onClose={() => setShowStats(false)}
                   onOpenGame={() => setSnakeMode(true)}
                   history={history}
               />

              <PrintReport history={history} members={members} balances={balances} settlements={settlements} />

              <header className="bg-gradient-to-br from-[#002f55] to-[#001f3f] dark:from-[#001f3f] dark:to-[#000a1f] text-white p-6 rounded-b-[2.5rem] shadow-xl mb-6 print:hidden text-center relative overflow-hidden transition-colors">
                <h1
                    onClick={handleTitleClick}
                    className="text-2xl font-bold flex items-center justify-center gap-2 relative z-10 cursor-pointer select-none active:scale-95 transition-transform"
                >
                    <Wallet className="text-[#e4b00f]" /> Malica Manager
                </h1>
                <div className="flex items-center justify-center gap-2 mt-1"><div className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div><p className="text-[#e4b00f] text-[10px] uppercase tracking-widest opacity-80">Cloud Sync Active</p></div>
              </header>

              <main className="max-w-md mx-auto px-4 print:hidden">
                {activeTab === 'dashboard' && (
                  <TabDashboard
                       payerRanking={payerRanking}
                       balances={balances}
                       setActiveTab={setActiveTab}
                       titles={titles}
                       onOpenRoulette={() => setShowRoulette(true)}
                       isBlurred={globalSettings.isBlurred}
                       onOpenStats={() => setShowStats(true)}
                      memberHunger={memberHunger}
                       onToggleHunger={toggleHungerAction}
                       dailyMessage={globalSettings.dailyMessage}
                       onEditMessage={openMessageModal}
                  />
                )}
                                {/* AKTIVACIJA NOVEGA ZAVIHEKA */}
                {activeTab === 'analytics' && <TabAnalytics history={history} members={members} setActiveTab={setActiveTab} isBlurred={globalSettings.isBlurred} darkMode={darkMode} />}
                                {activeTab === 'matrix' && <TabMatrix members={members} history={history} matrixType={matrixType} setMatrixType={setMatrixType} onPrint={handlePrintReport} />}
                {activeTab === 'add' && (
                  <TabAddEntry
                     addEntry={handleAddEntrySubmit} amount={amount} setAmount={setAmount} payer={payer} setPayer={setPayer} members={members}
                     selectedParticipants={selectedParticipants} setSelectedParticipants={setSelectedParticipants}
                     date={date} setDate={setDate} splitType={splitType} setSplitType={setSplitType}
                     manualAmounts={manualAmounts} setManualAmounts={setManualAmounts} isManualBalanced={isManualBalanced}
                   />
                )}
                {activeTab === 'history' && <TabHistory history={history} confirmDeleteEntry={confirmDeleteEntry} onToggleBlur={handleToggleBlur} />}
                {activeTab === 'settle' && !globalSettings.isBlurred && (
                  <TabSettlement
                     settlements={settlements} onPrint={handlePrintReport} showResetConfirm={showResetConfirm} setShowResetConfirm={setShowResetConfirm}
                     manualStartBalances={manualStartBalances} setManualStartBalances={setManualStartBalances} members={members}
                     balances={balances} isResetBalanced={isResetBalanced} isResetting={isResetting} finalizeReset={finalizeReset}
                     startResetProcess={startResetProcess} historyLength={history.length}
                     onOpenSettings={() => setActiveTab('settings')}
                  />
                )}
                {activeTab === 'settings' && (
                  <TabSettings
                     members={members} history={history} removeMember={removeMember}
                     showAddMember={showAddMember} setShowAddMember={setShowAddMember}
                     newMemberName={newMemberName} setNewMemberName={setNewMemberName} addMember={addMemberAction}
                     darkMode={darkMode} toggleDarkMode={handleToggleDarkMode}
                     instructions={globalSettings.instructions}
                     onEditInstructions={handleEditInstructions}
                     onRequestVisitLog={handleRequestVisitLog}
                     showVisitLog={showVisitLog}
                     visitHistory={visitHistory}
                  />
                )}
              </main>

              <Navigation activeTab={activeTab} setActiveTab={setActiveTab} isBlurred={globalSettings.isBlurred} />
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
